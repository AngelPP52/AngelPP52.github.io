<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端框架性能解析 | Shopee 供应链技术博客</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Share Our Knowledge.">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/assets/css/0.styles.65389751.css" as="style"><link rel="preload" href="/assets/js/app.89d7a7af.js" as="script"><link rel="preload" href="/assets/js/3.39c0dfdf.js" as="script"><link rel="preload" href="/assets/js/1.fc4f2573.js" as="script"><link rel="preload" href="/assets/js/27.a1d9dc04.js" as="script"><link rel="prefetch" href="/assets/js/10.8f886ff6.js"><link rel="prefetch" href="/assets/js/11.42709e7b.js"><link rel="prefetch" href="/assets/js/12.51c95e33.js"><link rel="prefetch" href="/assets/js/13.a7db2e06.js"><link rel="prefetch" href="/assets/js/14.b9fd5312.js"><link rel="prefetch" href="/assets/js/15.02f2a353.js"><link rel="prefetch" href="/assets/js/16.f2b3bba4.js"><link rel="prefetch" href="/assets/js/17.fa6f4a21.js"><link rel="prefetch" href="/assets/js/18.cc202cb1.js"><link rel="prefetch" href="/assets/js/19.b74d740a.js"><link rel="prefetch" href="/assets/js/20.4f1350b1.js"><link rel="prefetch" href="/assets/js/21.7011a4c9.js"><link rel="prefetch" href="/assets/js/22.71907870.js"><link rel="prefetch" href="/assets/js/23.7ea72b1e.js"><link rel="prefetch" href="/assets/js/24.156af4ed.js"><link rel="prefetch" href="/assets/js/25.705d13d1.js"><link rel="prefetch" href="/assets/js/26.90da6739.js"><link rel="prefetch" href="/assets/js/28.7b9ee58e.js"><link rel="prefetch" href="/assets/js/29.c14786fa.js"><link rel="prefetch" href="/assets/js/30.cc235e35.js"><link rel="prefetch" href="/assets/js/4.d90b791b.js"><link rel="prefetch" href="/assets/js/5.16307cd7.js"><link rel="prefetch" href="/assets/js/6.3a371881.js"><link rel="prefetch" href="/assets/js/7.40292f84.js"><link rel="prefetch" href="/assets/js/8.651698aa.js"><link rel="prefetch" href="/assets/js/9.fdd84905.js">
    <link rel="stylesheet" href="/assets/css/0.styles.65389751.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-19557b78><div data-v-19557b78><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-19557b78 data-v-19557b78><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-19557b78 data-v-19557b78><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>Shopee 供应链技术博客</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Shopee Supply Chain</span>
            
          <!---->
          2021
        </a></span></div></div> <div class="hide" data-v-19557b78><header class="navbar" data-v-19557b78><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/shopee.png" alt="Shopee 供应链技术博客" class="logo"> <span class="site-name">Shopee 供应链技术博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/database/" class="nav-link"><i class="iconfont undefined"></i>
  database
</a></li><li class="dropdown-item"><!----> <a href="/categories/CompilerTheory,Golang/" class="nav-link"><i class="iconfont undefined"></i>
  CompilerTheory,Golang
</a></li><li class="dropdown-item"><!----> <a href="/categories/MVCC/" class="nav-link"><i class="iconfont undefined"></i>
  MVCC
</a></li><li class="dropdown-item"><!----> <a href="/categories/golang/" class="nav-link"><i class="iconfont undefined"></i>
  golang
</a></li><li class="dropdown-item"><!----> <a href="/categories/Spark/" class="nav-link"><i class="iconfont undefined"></i>
  Spark
</a></li><li class="dropdown-item"><!----> <a href="/categories/CSS/" class="nav-link"><i class="iconfont undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/categories/efficiency/" class="nav-link"><i class="iconfont undefined"></i>
  efficiency
</a></li><li class="dropdown-item"><!----> <a href="/categories/Performance/" class="nav-link"><i class="iconfont undefined"></i>
  Performance
</a></li><li class="dropdown-item"><!----> <a href="/categories/http/" class="nav-link"><i class="iconfont undefined"></i>
  http
</a></li><li class="dropdown-item"><!----> <a href="/categories/react/" class="nav-link"><i class="iconfont undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/categories/Middleware/" class="nav-link"><i class="iconfont undefined"></i>
  Middleware
</a></li><li class="dropdown-item"><!----> <a href="/categories/Security/" class="nav-link"><i class="iconfont undefined"></i>
  Security
</a></li><li class="dropdown-item"><!----> <a href="/categories/git/" class="nav-link"><i class="iconfont undefined"></i>
  git
</a></li><li class="dropdown-item"><!----> <a href="/categories/Algorithm/" class="nav-link"><i class="iconfont undefined"></i>
  Algorithm
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-19557b78></div> <aside class="sidebar" data-v-19557b78><div class="personal-info-wrapper" data-v-b038cec6><img src="/shopee.png" alt="author-avatar" class="personal-img" data-v-b038cec6> <h3 class="name" data-v-b038cec6>
    Shopee Supply Chain
  </h3> <div class="num" data-v-b038cec6><div data-v-b038cec6><h3 data-v-b038cec6>17</h3> <h6 data-v-b038cec6>Article</h6></div> <div data-v-b038cec6><h3 data-v-b038cec6>17</h3> <h6 data-v-b038cec6>Tag</h6></div></div> <hr data-v-b038cec6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/database/" class="nav-link"><i class="iconfont undefined"></i>
  database
</a></li><li class="dropdown-item"><!----> <a href="/categories/CompilerTheory,Golang/" class="nav-link"><i class="iconfont undefined"></i>
  CompilerTheory,Golang
</a></li><li class="dropdown-item"><!----> <a href="/categories/MVCC/" class="nav-link"><i class="iconfont undefined"></i>
  MVCC
</a></li><li class="dropdown-item"><!----> <a href="/categories/golang/" class="nav-link"><i class="iconfont undefined"></i>
  golang
</a></li><li class="dropdown-item"><!----> <a href="/categories/Spark/" class="nav-link"><i class="iconfont undefined"></i>
  Spark
</a></li><li class="dropdown-item"><!----> <a href="/categories/CSS/" class="nav-link"><i class="iconfont undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/categories/efficiency/" class="nav-link"><i class="iconfont undefined"></i>
  efficiency
</a></li><li class="dropdown-item"><!----> <a href="/categories/Performance/" class="nav-link"><i class="iconfont undefined"></i>
  Performance
</a></li><li class="dropdown-item"><!----> <a href="/categories/http/" class="nav-link"><i class="iconfont undefined"></i>
  http
</a></li><li class="dropdown-item"><!----> <a href="/categories/react/" class="nav-link"><i class="iconfont undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/categories/Middleware/" class="nav-link"><i class="iconfont undefined"></i>
  Middleware
</a></li><li class="dropdown-item"><!----> <a href="/categories/Security/" class="nav-link"><i class="iconfont undefined"></i>
  Security
</a></li><li class="dropdown-item"><!----> <a href="/categories/git/" class="nav-link"><i class="iconfont undefined"></i>
  git
</a></li><li class="dropdown-item"><!----> <a href="/categories/Algorithm/" class="nav-link"><i class="iconfont undefined"></i>
  Algorithm
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端框架性能解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/views/fe/react/framework_and_performance.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/fe/react/framework_and_performance.html#框架中的几个关键词" class="sidebar-link">框架中的几个关键词</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/fe/react/framework_and_performance.html#框架性能到底指什么" class="sidebar-link">框架性能到底指什么</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/fe/react/framework_and_performance.html#react-性能设计亮点" class="sidebar-link">React 性能设计亮点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/fe/react/framework_and_performance.html#_1-react-性能设计亮点之事件" class="sidebar-link">1. React 性能设计亮点之事件</a></li><li class="sidebar-sub-header"><a href="/views/fe/react/framework_and_performance.html#_2-react-性能设计亮点之-setstate" class="sidebar-link">2. React 性能设计亮点之 setState</a></li><li class="sidebar-sub-header"><a href="/views/fe/react/framework_and_performance.html#_3-react-性能设计亮点之-react-fiber" class="sidebar-link">3. React 性能设计亮点之 React fiber</a></li><li class="sidebar-sub-header"><a href="/views/fe/react/framework_and_performance.html#_4-react-的虚拟-dom-diff" class="sidebar-link">4. React 的虚拟 DOM diff</a></li></ul></li><li><a href="/views/fe/react/framework_and_performance.html#vue-3-0-动静结合的-dom-diff" class="sidebar-link">Vue 3.0 动静结合的 Dom diff</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/fe/react/framework_and_performance.html#预编译优化及其本质" class="sidebar-link">预编译优化及其本质</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/fe/react/framework_and_performance.html#_1-hoist-constant-elements" class="sidebar-link">1. Hoist constant elements</a></li><li class="sidebar-sub-header"><a href="/views/fe/react/framework_and_performance.html#_2-remove-proptypes-in-runtime" class="sidebar-link">2. Remove propTypes in runtime</a></li><li class="sidebar-sub-header"><a href="/views/fe/react/framework_and_performance.html#_3-remove-inline-functions-and-varaibles" class="sidebar-link">3. Remove inline functions and varaibles</a></li><li class="sidebar-sub-header"><a href="/views/fe/react/framework_and_performance.html#_4-transform-to-stateless-function-component" class="sidebar-link">4. Transform to stateless function component</a></li><li class="sidebar-sub-header"><a href="/views/fe/react/framework_and_performance.html#延伸阅读：-prepack" class="sidebar-link">延伸阅读： Prepack</a></li></ul></li><li><a href="/views/fe/react/framework_and_performance.html#结尾" class="sidebar-link">结尾</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-19557b78><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>前端框架性能解析</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Shopee Supply Chain</span>
            
          <!---->
          2021
        </a></span></div></div> <div data-v-19557b78><main class="page"><div class="page-title" style="display:none;"><h1>前端框架性能解析</h1> <hr> <div data-v-484a899e><i class="iconfont reco-account" data-v-484a899e><span data-v-484a899e>KK</span></i> <i class="iconfont reco-date" data-v-484a899e><span data-v-484a899e>2020-12-01</span></i> <!----> <i class="iconfont reco-tag tags" data-v-484a899e><span class="tag-item" data-v-484a899e>
      react
    </span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b271c284a3e9471f827eae7d3e138db0~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>当下的前端开发，一般都用到了譬如<code>React</code>， <code>Vue</code> 之类的前端框架。</p> <p>框架使得我们只需要关注<code>数据层</code>和<code>视图层</code>，不需要关注底层逻辑，但是如果需要一些比较复杂的场景需要做性能优化的时候， 就需要去了解框架背后的一些原理了。</p> <p>今天这篇文章，我们就来聊一下前端框架与性能， 希望给大家一些启发。</p> <h1 id="正文"><a href="#正文" class="header-anchor">#</a> 正文</h1> <h2 id="框架中的几个关键词"><a href="#框架中的几个关键词" class="header-anchor">#</a> 框架中的几个关键词</h2> <p>其实， 如果对框架进行一下提炼的话， 就会得到这几个关键词：</p> <ul><li><code>双向绑定</code></li> <li><code>依赖收集</code></li> <li><code>Pub/Sub</code></li> <li><code>MVC/MVVM</code></li> <li><code>虚拟DOM</code></li> <li><code>虚拟DOM Diff</code></li> <li><code>模板编译</code></li> <li><code>...</code></li></ul> <p>无论是<code>Vue</code> 还是 <code>React</code>， 在其框架内部都做了很多与性能相关的处理。</p> <h2 id="框架性能到底指什么"><a href="#框架性能到底指什么" class="header-anchor">#</a> 框架性能到底指什么</h2> <p>我们知道，页面<code>每一帧</code>的变化都是由浏览器<code>绘制</code>出来的，并且这个绘制频率受限于显示器的<code>刷新频率</code>。</p> <p>因此一个重要的性能数据指标是： <code>每秒 60 帧的绘制频率</code>。</p> <p>这样进行简单的换算之后，每一帧只有 <code>16.6ms</code> 的绘制时间。</p> <p>如果一个应用对用户的交互响应处理过慢，则需要花费很长的时间来计算更新数据，这就造成了应用缓慢、性能低下的问题，被用户感知造成极差的用户体验。</p> <p>对于框架来说，以 React 为例，开发者不需要额外关注 DOM 层面的操作。</p> <p>因为 React 通过维护<code>虚拟 DOM</code> 及其高效的 <code>Diff 算法</code>，可以决策出每次更新的最小化 <code>DOM batch</code> 操作。</p> <p>但实际上，使用 React 能完成的性能优化，使用纯原生的 JavaScript 都能做到，甚至做得更好。</p> <p>只不过经过 React 统一处理后，大大节省了开发成本，同时也降低了应用性能对开发者优化技能的依赖。</p> <p>因此现代框架的性能表现，除了想办法缩减自身的 <code>bundle size</code> 之外，主要优化点就在于:</p> <p><code>框架本身</code>运行时对 DOM 层操作的<code>合理性</code>, 以及自身引擎计算的<code>高效性</code>。</p> <p>这些优化都绕不开一个关键词：<code>虚拟DOM</code>。</p> <p>下面我就以React为例，来展开这个话题。</p> <h2 id="react-性能设计亮点"><a href="#react-性能设计亮点" class="header-anchor">#</a> React 性能设计亮点</h2> <p>React 设计上的性能亮点非常多，除了「老生常谈」的虚拟 DOM 之外，还有很多不为人知的细节，比如事件机制（合成和池化）、React fiber 设计。</p> <h3 id="_1-react-性能设计亮点之事件"><a href="#_1-react-性能设计亮点之事件" class="header-anchor">#</a> 1. React 性能设计亮点之事件</h3> <p>React 事件机制我们前面已经有所介绍，总结一下性能亮点的体现有：</p> <ul><li>将所有事件挂载到 document 节点上，利用事件代理实现优化；</li> <li>采用合成事件，在原生事件的基础上包装合成事件，并结合池化思路实现内存保护。</li></ul> <p>有一点需要注意的是， 在 React V17 中， React 不会再将事件处理添加到 document 上，而是将事件处理添加到渲染 React 树的根 DOM 容器中：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> rootNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> rootNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在 React 16 及之前版本中，React 会对大多数事件进行 document.addEventListener() 操作。</p> <p>React v17 开始会通过调用 rootNode.addEventListener() 来代替。</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6f6c5d5b8ddc46af9f0014f5cee9a0a8~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>更改事件委托结点的原因如下：</p> <p>从技术上讲，始终可以在应用程序中嵌套不同版本的 React。但是，由于 React 事件系统的工作原理，这很难实现。</p> <p>在 React 组件中，通常会内联编写事件处理：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>与此代码等效的原生 DOM 操作如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>myButton<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> handleClick<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>但是，对大多数事件来说，React 实际上并不会将它们附加到 DOM 节点上。</p> <p>相反，React 会直接在 <code>document</code>节点上为每种事件类型附加一个处理器, 这被称为<code>事件委托</code>。</p> <p>除了在大型应用程序上具有性能优势外，它还使添加类似于 replaying events 这样的新特性变得更加容易。</p> <p>自从其发布以来，React 一直自动进行事件委托。</p> <p>当 document 上触发 DOM 事件时，React 会找出调用的组件，然后 React 事件会在组件中向上 “冒泡”。</p> <p>但实际上，原生事件已经冒泡出了 document 级别，React 在其中安装了事件处理器。</p> <p>但是，这就是<code>逐步升级</code>的困难所在。</p> <p>如果页面上有多个 React 版本，他们都将在顶层注册事件处理器。</p> <p>这会破坏 e.stopPropagation()：如果嵌套树结构中阻止了事件冒泡，但外部树依然能接收到它。</p> <p>这会<code>使不同版本 React 嵌套变得困难重重</code>。</p> <p>这也是为什么要改变 React 底层附加事件方式的原因。</p> <h3 id="_2-react-性能设计亮点之-setstate"><a href="#_2-react-性能设计亮点之-setstate" class="header-anchor">#</a> 2. React 性能设计亮点之 setState</h3> <p>setState 这个谜之 API 我们也有所介绍，其异步（或者叫做 batch 合并）设计也是出于性能的考虑。</p> <p>这种优化思路已经被很多框架所借鉴，Vue 当中也是有类似的设计。</p> <h3 id="_3-react-性能设计亮点之-react-fiber"><a href="#_3-react-性能设计亮点之-react-fiber" class="header-anchor">#</a> 3. React 性能设计亮点之 React fiber</h3> <p>前面两个「亮点」我们在以往的课程中已经有所涉及，这里来重点说一下 <code>React fiber</code>。</p> <p>我们知道在浏览器主线程中，JavaScript 代码在调用栈 call stack 执行时，可能会调用浏览器的 APIs，对 DOM 进行操作, 也可能执行一些异步任务。</p> <p>这些异步任务如果是以回调的方式处理，那么往往会被添加到 event queue 当中；
如果是以 promise 处理，就会先放到 job queue 当中。</p> <p>这个涉及到<code>宏任务</code>和<code>微任务</code>，这些异步任务和渲染任务将会在<code>下一个时序</code>当中由调用栈处理执行。</p> <p>理解了这些，大家就会明白：如果调用栈 call stack 运行一个很耗时的脚本，比如解析一个图片，call stack 就会像上下班高峰期的环路入口一样，被这个复杂任务堵塞。</p> <p>主线程其他任务都要排队，进而阻塞 UI 响应。这时候用户点击、输入、页面动画等都没有了响应， 形成<code>卡顿</code>。</p> <p>这样的性能瓶颈，在一定程度上限制着 JavaScript 的发挥。</p> <p>我们一般有两种方案突破上文提到的瓶颈，其中之一就是将耗时高、成本高、易阻塞的<code>长任务切片</code>，分成<code>子任务</code>，并<code>异步执行</code>。</p> <p>这样一来，这些子任务会在不同的 call stack tick 周期执行，进而主线程就可以在子任务间隙当中执行 UI 更新操作。</p> <p>设想一个常见的场景：如果我们需要渲染一个由十万条数据组成的列表，那么相比一次性渲染全部数据，我们可以将数据分段，使用 setTimeout API 去分步处理，构建渲染列表的工作就被分成了不同的子任务在浏览器中执行。</p> <p>在这些子任务间隙，浏览器得以处理 UI 更新。</p> <p>React 在 JavaScript 执行层面花费的时间较多，这是因为下面一系列复杂过程所造成的：</p> <blockquote><p>Virtual DOM 构建 → 计算 DOM diff → 生成 render patch</p></blockquote> <p>也就是说，在一定程度上：</p> <p>React 著名的调度策略 -- stack reconcile 是 React 的性能瓶颈。</p> <p>因为 React stack reconcile 过程会深度优先遍历所有的 Virtual DOM 节点，进行 diff。</p> <p>整棵 Virtual DOM 树计算完成之后，将任务出栈释放主线程。</p> <p>因此，浏览器主线程被 React 更新状态任务占据的时候，用户与浏览器进行任何交互都不能得到反馈，只有等到任务结束，才能得到浏览器的响应。</p> <p>我们来看一个典型的场景，内容来自文章：<a href="https://www.infoq.cn/article/what-the-new-engine-of-react/" target="_blank" rel="noopener noreferrer">React 的新引擎—React Fiber 是什么？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>这个例子会在页面中创建一个输入框、一个按钮、一个 BlockList 组件。</p> <p>BlockList 组件会根据 NUMBER_OF_BLOCK 数值渲染出对应数量的数字显示框，数字显示框显示点击按钮的次数。</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2d931e8af8b143e8abec1b1d50ec6752~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>在这个例子中，我们可以设置 NUMBER_OF_BLOCK 的值为 100000，表示渲染 100000 个矩形框。</p> <p>这时候点击按钮，触发 setState，页面开始更新。</p> <p>此时点击输入框，输入一些字符串，比如 「hi，react」，可以看到：</p> <p>页面没有任何响应；等待 7s 之后，输入框中突然出现了之前输入的 「hireact」。同时，BlockList 组件也更新了。</p> <p>显而易见，这样的用户体验并不好。</p> <p>浏览器主线程在这 7s 的 <code>performance</code> 如下图所示：</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/841d671d9e814a5596edf2ad57eb64e2~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <ul><li>黄色部分：是 JavaScript 执行时间，也是 React 占用主线程的时间。</li> <li>紫色部分：是浏览器重新计算 DOM Tree 的时间。</li> <li>绿色部分：是浏览器绘制页面的时间。</li></ul> <p>这三种任务，总共占用浏览器主线程 7s 的时间，此时间内浏览器无法与用户交互。</p> <p>主要是黄色部分执行时间较长，占用了 6s，即 React 较长时间占用主线程，导致主线程无法响应用户输入。</p> <p>这就是一个典型的例子。</p> <hr> <p>React 核心团队很早之前就预知性能风险的存在，并且持续探索可解决的方式。</p> <p>基于浏览器对 <code>requestIdleCallback</code> 和 <code>requestAnimationFrame</code> 这两个 API 的支持，React 团队实现新的调度策略 —— <code>Fiber reconcile</code>。</p> <p>在应用 React Fiber 的场景下，重复刚才的例子，不会再出现页面卡顿，交互自然而顺畅。</p> <p>浏览器主线程的 performance 如下图所示：</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d4b7a42e874b4977b18ab3b8d126dd04~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>可以看到：</p> <p>在黄色 JavaScript 执行过程中，也就是 React 占用浏览器主线程期间，浏览器也在重新计算 DOM Tree，并且进行重绘。</p> <p>直观来看，黄色和紫色等互相交替，同时页面截图显示，用户输入得以及时响应。</p> <p>简单说，在 React 占用浏览器主线程期间，浏览器也在与用户交互。这显然是「更好的性能」表现。</p> <h3 id="_4-react-的虚拟-dom-diff"><a href="#_4-react-的虚拟-dom-diff" class="header-anchor">#</a> 4. React 的虚拟 DOM diff</h3> <p>React 主要通过以下几种方式来保证虚拟的 DOM diff 算法和更新的高效性能：</p> <ul><li>高效的 diff 算法</li> <li>Batch 操作</li> <li>摒弃脏检测更新方式</li></ul> <p>当任何一个组件使用 setState 方法时，React 都会认为该组件变「脏」，触发组件本身的重新渲染。</p> <p>同时因其始终维护两套虚拟的 DOM，其中一套是更新后的虚拟的 DOM；</p> <p>另一套是前一个状态的虚拟的 DOM。通过对这两套虚拟的 DOM 的 diff 算法，找到需要变化的最小单元集，然后把这个最小单元集应用在真实的 DOM 当中。</p> <p>而通过 diff 算法找到这个最小单元集后，React 采用「 启发式 」的思路进行了一些假设，最终的效果是：</p> <p>将两棵 DOM 树之间的 diff 成本, 由 O(n3) 缩减到了 O(n)， 性能得到了巨大的提升。</p> <p>说到这里，你一定很想知道 React 的那些大胆假设吧：</p> <ul><li>DOM 节点跨层级移动忽略不计</li> <li>拥有相同类的两个组件生成相似的树形结构，拥有不同类的两个组件生成不同的树形结构</li> <li>当对同一层级节点进行比较时，对于相同的组件类型，如果组件的 state 或 props 发生变化，则直接重新渲染组件本身。开发者可以尝试使用 shouldComponentUpdate 生命周期函数来规避不必要的渲染。</li> <li>当对同一层级节点进行比较时，开发者可以使用 key 属性来「声明」同一层级节点的更新方式。</li></ul> <p>根据这些假设，ReactJS 采取的策略如下：</p> <p>React 对组件树进行分层比较，两棵树只会对同一层级的节点进行比较
当对同一层级节点进行比较时，对于不同的组件类型，直接将整个组件替换为新类型组件</p> <p>对于下图所示的组件结构：</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cbdc659af3a849cc94d8f49940387565~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>我们可以想象：</p> <p>如果子组件 B 和 H 的类型同时发生变化，当遍历到 B 组件时，直接进行新组件的替换，从而减少了不必要的消耗。</p> <p>另外，setState 方法引发了「蝴蝶效应」，并通过创新的 diff 算法找到需要更新的最小单元集，但是这些变更也并不一定立即同步产生。</p> <p>实际上，React 会进行 setState 的 batch 操作，通俗地讲就是「积攒归并」一批变化后，再统一进行更新。</p> <p>显然这也是出于对性能的考虑。</p> <h2 id="vue-3-0-动静结合的-dom-diff"><a href="#vue-3-0-动静结合的-dom-diff" class="header-anchor">#</a> Vue 3.0 动静结合的 Dom diff</h2> <p>Vue3.0 提出的动静结合的 DOM diff 思想，我个人认为是 Vue 近几年在「创新」上的一个很好体现。</p> <p>之所以能够做到动静结合的 DOM diff，或者把这个问题放得更大：</p> <p>之所以能够做到预编译优化，是因为 Vue core 可以静态分析 template，在解析模版时，整个 parse 的过程是利用正则表达式顺序解析模板。</p> <p>当解析到开始标签、闭合标签和文本的时候都会分别执行对应的回调函数，来达到构造 <code>AST</code> 树的目的。</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2c2303174362419baa1acc400267950d~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>这个过程换成代码如下：</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ade65de0cb8a4559ad7e742dd32a54ba~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>借助预编译过程，Vue 可以做到的预编译优化就很强大了。</p> <p>比如在预编译时标记出模版中可能变化的组件节点，再次进行渲染前 diff 时就可以跳过「永远不会变化的节点」，而只需要对比「可能会变化的动态节点」。</p> <p>这也就是动静结合的 DOM diff 将 diff 成本与模版大小正相关优化到与动态节点正相关的理论依据。</p> <p>类似地，我们也可以标记出来一些<code>快速通道</code>（fast path）。</p> <p>比如某个复杂的组件之所以 className 发生变化（这个场景很常见，我们根据变量，通过更改 className 来应用不同的样式）。</p> <p>针对这种场景，可以在<code>预编译</code>阶段进行特定的标记，在重新渲染 diff 时只需要更新新的 className 即可。</p> <h2 id="预编译优化及其本质"><a href="#预编译优化及其本质" class="header-anchor">#</a> 预编译优化及其本质</h2> <p>Vue 需要做<code>数据双向绑定</code>，需要进行数据拦截或代理，那它就需要在预编译阶段静态分析模版，分析出视图依赖了哪些数据，进行响应式处理。</p> <p>而 React 就是<code>局部重新渲染</code>，React 拿到的或者说掌管的，所负责的就是一堆<code>递归</code>。</p> <p><code>React.createElement</code> 的执行调用，它<code>无法从模版层面进行静态分析</code>。</p> <p>比如这样的 JSX：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>This is a test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>将会被编译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
 <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
 React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
   <span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
   React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
     <span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;This is a test&quot;</span>
   <span class="token punctuation">)</span>
 <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>因此 React JSX 过度的灵活性导致运行时可以用于优化的信息不足。但是，在 React 框架之外，我们作为开发者还是可以通过工程化手段达到类似的目的，因为我们能够接触到 JSX 编译成 React.createElement 的整个过程。</p> <p>开发者在项目中开发 babel 插件，实现 JSX 编译成 React.createElement，那么优化手段就是是从编写 babel 插件开始：</p> <p>如图：</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3d99aaf843ff49d79e8dd825224039ff~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>那么到底开发者应该怎么做，实现预编译优化呢？</p> <p>为此我挑出了一些具有代表性的案例，这些案例都是由开发者开发 Babel plugin 实现的 React 预编译手段。</p> <h3 id="_1-hoist-constant-elements"><a href="#_1-hoist-constant-elements" class="header-anchor">#</a> 1. Hoist constant elements</h3> <p>将静态不变的节点在预编译阶段就抽象成函数或者静态变量，这个和 Vue 框架内所做的一样，不过需要开发者实现，这样一来就不需要在每次重新渲染时生成多余实例，只需要调用 _ref 变量即可。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> _ref <span class="token operator">=</span> Hello World<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MyComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
 <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span>
       <span class="token punctuation">{</span>_ref<span class="token punctuation">}</span>
   <span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_2-remove-proptypes-in-runtime"><a href="#_2-remove-proptypes-in-runtime" class="header-anchor">#</a> 2. Remove propTypes in runtime</h3> <p>PropTypes 提供了许多验证工具，用来帮助确定 React 组件中 props 数据的有效性。但是，React v15.5 后就被移除了 PropTypes ，因此现在使用 prop-types 库代替。</p> <p>propTypes 对于业务开发非常有用，帮助我们弥补了 JS 数据类型检查的不足。但是在线上代码中，propTypes 是多余的。</p> <p>因此在运行时代码删除 propTypes 就变的比较有必要了。</p> <h3 id="_3-remove-inline-functions-and-varaibles"><a href="#_3-remove-inline-functions-and-varaibles" class="header-anchor">#</a> 3. Remove inline functions and varaibles</h3> <p>第三个优化场景是这样的：我们知道组件内如果存在函数生成（箭头函数定义，bind 使用）或者闭包变量的情况下，组件每一次刷新，都会生成一个新的函数或者闭包变量。</p> <p>我们将这种不必要的函数称为 inline functions。</p> <p>比如下面这段代码中，transformeData 和 onClick 对应的匿名函数，都会随着组件渲染重新生成一个全新的引用。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data<span class="token punctuation">,</span> sortComparator<span class="token punctuation">,</span> filterPredicate<span class="token punctuation">,</span> history <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  <span class="token keyword">const</span> transformedData <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>filterPredicate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>sortComparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>button
        className<span class="token operator">=</span><span class="token string">&quot;back-btn&quot;</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> history<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span>transformedData<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> id<span class="token punctuation">,</span> value <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
			<span class="token comment">// do something with id and value</span>
		<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>  
  <span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>反复生成这些 inline functions 或者数据，这对于 React 运行时性能或多或少会有一点影响，也带来了 GC 压力。</p> <p>我们在工程中，可以通过插件对 inline functions 或者变量进行内存持久化处理。最终经过预编译优化后的代码为：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> _anonymousFnComponent

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data<span class="token punctuation">,</span> sortComparator<span class="token punctuation">,</span> filterPredicate<span class="token punctuation">,</span> history <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

 <span class="token keyword">const</span> transformedData <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useMemo</span><span class="token punctuation">(</span>
   <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> data<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>filterPredicate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>sortComparator<span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span>data<span class="token punctuation">,</span> data<span class="token punctuation">.</span>filter<span class="token punctuation">,</span> filterPredicate<span class="token punctuation">,</span> sortComparator<span class="token punctuation">]</span>
 <span class="token punctuation">)</span>

 <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>_anonymousFnComponent <span class="token operator">=</span> _anonymousFnComponent <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

   <span class="token keyword">const</span> _onClick2 <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> history<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>history<span class="token punctuation">,</span> history<span class="token punctuation">.</span>pop<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">return</span> <span class="token punctuation">(</span>
   	 <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
         <span class="token punctuation">{</span> transformedData<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> id<span class="token punctuation">,</span> value <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
             React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
               <span class="token comment">//...</span>
             <span class="token punctuation">)</span>
           <span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>  
   <span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>我们使用了 React 新特性 <code>useMemo</code> 和 <code>useCallback</code> 将这些变量包裹。</p> <p><code>useMemo</code> 和 <code>useCallback</code> 都会在组件第一次渲染的时候执行，之后会在其依赖的变量，也就是 useMemo 和 useCallback 的第二个参数数组。</p> <p>数组内的数值发生改变时再次执行；</p> <p>这两个 hooks 都返回缓存的值，useMemo 返回<code>缓存的变量</code>，useCallback 返回<code>缓存的函数</code>。</p> <p>我们看代码，transformeData 在其数据源：</p> <p>data,data.filter,filterPredicate,sortComparator <code>发生变化</code>时才会更新，才会重新生成一份 transformeData。</p> <p>函数渲染时只要依赖的 data,data.filter,filterPredicate,sortComparator 不变，不会重新生成 transformeData，而是使用缓存的值。</p> <p>onClick 也使用了 useCallback 将函数引用持久化保存，道理一样。</p> <p>这样一来就避免了在组件重新渲染时，总是生成不必要的 inline functions 和闭包变量的困扰。</p> <h3 id="_4-transform-to-stateless-function-component"><a href="#_4-transform-to-stateless-function-component" class="header-anchor">#</a> 4. Transform to stateless function component</h3> <p>我们知道函数式组件虽然未来会比 class 声明的组件性能更好，并且函数不管是从性能上、可组合性上还是 TS 契合度上，都要要优于 class 使用。</p> <p>这个例子，我们将符合条件的 class 声明组件自动在预编译阶段转化为函数式组件。</p> <p>我们的目标是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">MyComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
 <span class="token keyword">static</span> propTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
   className<span class="token operator">:</span> React<span class="token punctuation">.</span>PropTypes<span class="token punctuation">.</span>string<span class="token punctuation">.</span>isRequired
 <span class="token punctuation">}</span>

 <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span>
       Hello World
   <span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在预编译阶段优化为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">MyComponent</span> <span class="token operator">=</span> <span class="token parameter">props</span> <span class="token operator">=&gt;</span> Hello World
MyComponent<span class="token punctuation">.</span>propTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
 className<span class="token operator">:</span> React<span class="token punctuation">.</span>PropTypes<span class="token punctuation">.</span>string<span class="token punctuation">.</span>isRequired
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在这里我们展开实现一下 <code>Babel plugin</code> 的编写，其中会涉及到一些 <code>AST</code> 的内容：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token operator">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token punctuation">{</span>
   visitor<span class="token operator">:</span> <span class="token punctuation">{</span>
     <span class="token function">Class</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">{</span>
         renderMethod<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
         properties<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         thisProps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         isPure<span class="token operator">:</span> <span class="token boolean">true</span>
       <span class="token punctuation">}</span>

       path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>bodyVisitor<span class="token punctuation">,</span> state<span class="token punctuation">)</span>

       <span class="token keyword">let</span> replacement <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

       state<span class="token punctuation">.</span>thisProps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">thisProp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         thisProp<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'props'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         thisProp<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'props'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span>

       replacement<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
         t<span class="token punctuation">.</span><span class="token function">functionDeclaration</span><span class="token punctuation">(</span>
           id<span class="token punctuation">,</span>
           <span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'props'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
           state<span class="token punctuation">.</span>renderMethod<span class="token punctuation">.</span>node<span class="token punctuation">.</span>body
         <span class="token punctuation">)</span>
       <span class="token punctuation">)</span>

       state<span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">prop</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         replacement<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">expressionStatement</span><span class="token punctuation">(</span>
           t<span class="token punctuation">.</span><span class="token function">assignmentExpression</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">,</span>
             t<span class="token punctuation">.</span><span class="token function">MemberExpression</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> prop<span class="token punctuation">.</span>node<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span>
             prop<span class="token punctuation">.</span>node<span class="token punctuation">.</span>value
           <span class="token punctuation">)</span>
         <span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isExpression</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         replacement<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">returnStatement</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>

         replacement <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>
           t<span class="token punctuation">.</span><span class="token function">functionExpression</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
             t<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span>replacement<span class="token punctuation">)</span>
           <span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token punctuation">[</span><span class="token punctuation">]</span>
         <span class="token punctuation">)</span>
       <span class="token punctuation">}</span>

       path<span class="token punctuation">.</span><span class="token function">replaceWithMultiple</span><span class="token punctuation">(</span>
         replacement
       <span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>

 <span class="token keyword">const</span> bodyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token function">ClassMethod</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>key<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'render'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>renderMethod <span class="token operator">=</span> path
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>isPure <span class="token operator">=</span> <span class="token boolean">false</span>
       path<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>

   <span class="token function">ClassProperty</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">const</span> name <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>key<span class="token punctuation">.</span>name

     <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>static <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
       name <span class="token operator">===</span> <span class="token string">'propTypes'</span> <span class="token operator">||</span>
       name <span class="token operator">===</span> <span class="token string">'defaultProps'</span>
     <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>isPure <span class="token operator">=</span> <span class="token boolean">false</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>isPure <span class="token operator">=</span> <span class="token boolean">false</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>

   <span class="token function">MemberExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span>thisProps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>

   <span class="token function">JSXIdentifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'ref'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>isPure <span class="token operator">=</span> <span class="token boolean">false</span>
       path<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br></div></div><p>代码分析：<em><strong>我们先明确，什么样的 class 组件，具备转换成函数式组件的条件 ？</strong></em></p> <p>首先，class 组件不能具有 <code>this.state</code> 的引用，组件不能出现任何<code>生命周期方法</code>，也不能出现 <code>createRef</code> 。</p> <p>因为这些特性在函数式组件中并不存在。</p> <p>满足这样的条件时，我们在进行 JSX 转换过程进行组件替换：</p> <p>通过 AST 进行遍历， 首先在遍历过程中找到符合条件的 class 组件，是否符合条件我们用 isPure 来进行标记。</p> <p>同时在遍历时，对每一个符合条件的 class 组件，储存 render 方法，作为转换函数式组件的返回值；</p> <p>储存 propTypes 和 defaultProps 静态属性，之后会挂载在函数组件函数属性上；</p> <p>同时对 this.props 的用法转为 props, props 作为函数式组件的参数出现。</p> <p>最后在按照上述规则，修改 AST 树，新的 AST 树相关组件节点会生成函数式组件。</p> <h3 id="延伸阅读：-prepack"><a href="#延伸阅读：-prepack" class="header-anchor">#</a> 延伸阅读： <a href="https://github.com/facebook/prepack" target="_blank" rel="noopener noreferrer">Prepack<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h3> <blockquote><p>Prepack is a partial evaluator for JavaScript. Prepack rewrites a JavaScript bundle, resulting in JavaScript code that executes more efficiently. For initialization-heavy code, Prepack works best in an environment where JavaScript parsing is effectively cached.</p></blockquote> <p>我们看一个 fibonacci 数列求和的例子，再经过 prepack 处理之后，直接输出结果。</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ee5d3fa261bd45c2b45376126f421ce2~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>这么看 prepack 是一个 JavaScript 的部分求值器（Partial Evaluator），可在编译时执行原本在运行时的计算过程，并通过重写 JavaScript 代码来提高其执行效率。</p> <p>用 Prepack 结合 React 做一下尝试：</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/557803068b3c439fb4a5753218b93bf3~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>左边部分是我编写的测试代码，在不使用 prepack 情况下，运行时代码如右边所示：</p> <p>经过编译之后右边的代码仍然是对数组 list 进行 map，逐条渲染出数组内容。</p> <p>经过 preack 优化后，运行时代码已经非常轻量了， 运行时就减少 map 的计算等，直接用生成的组件内容作为运行时结果：</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cd8ffbaf6dc14a13861e56f05e0d039b~tplv-k3u1fbpfcp-watermark.image" alt="">
s</p> <h2 id="结尾"><a href="#结尾" class="header-anchor">#</a> 结尾</h2> <p>性能优化是一个永恒的话题，框架中的一些优化手段值得我们借鉴和学习。</p> <p>希望今天这篇文章能对大家有所启发。</p> <p>文中如有错误， 欢迎指正， 谢谢。</p></div> <footer class="page-edit" style="display:none;"><!----> <!----></footer> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-44bd5a18 data-v-44bd5a18><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-44bd5a18><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-44bd5a18></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-44bd5a18></path></svg></div></div></div>
    <script src="/assets/js/app.89d7a7af.js" defer></script><script src="/assets/js/3.39c0dfdf.js" defer></script><script src="/assets/js/1.fc4f2573.js" defer></script><script src="/assets/js/27.a1d9dc04.js" defer></script>
  </body>
</html>
