<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>当前端聊安全时，前端在聊什么？ | Shopee 供应链技术博客</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Share Our Knowledge.">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/assets/css/0.styles.65389751.css" as="style"><link rel="preload" href="/assets/js/app.89d7a7af.js" as="script"><link rel="preload" href="/assets/js/3.39c0dfdf.js" as="script"><link rel="preload" href="/assets/js/1.fc4f2573.js" as="script"><link rel="preload" href="/assets/js/28.7b9ee58e.js" as="script"><link rel="prefetch" href="/assets/js/10.8f886ff6.js"><link rel="prefetch" href="/assets/js/11.42709e7b.js"><link rel="prefetch" href="/assets/js/12.51c95e33.js"><link rel="prefetch" href="/assets/js/13.a7db2e06.js"><link rel="prefetch" href="/assets/js/14.b9fd5312.js"><link rel="prefetch" href="/assets/js/15.02f2a353.js"><link rel="prefetch" href="/assets/js/16.f2b3bba4.js"><link rel="prefetch" href="/assets/js/17.fa6f4a21.js"><link rel="prefetch" href="/assets/js/18.cc202cb1.js"><link rel="prefetch" href="/assets/js/19.b74d740a.js"><link rel="prefetch" href="/assets/js/20.4f1350b1.js"><link rel="prefetch" href="/assets/js/21.7011a4c9.js"><link rel="prefetch" href="/assets/js/22.71907870.js"><link rel="prefetch" href="/assets/js/23.7ea72b1e.js"><link rel="prefetch" href="/assets/js/24.156af4ed.js"><link rel="prefetch" href="/assets/js/25.705d13d1.js"><link rel="prefetch" href="/assets/js/26.90da6739.js"><link rel="prefetch" href="/assets/js/27.a1d9dc04.js"><link rel="prefetch" href="/assets/js/29.c14786fa.js"><link rel="prefetch" href="/assets/js/30.cc235e35.js"><link rel="prefetch" href="/assets/js/4.d90b791b.js"><link rel="prefetch" href="/assets/js/5.16307cd7.js"><link rel="prefetch" href="/assets/js/6.3a371881.js"><link rel="prefetch" href="/assets/js/7.40292f84.js"><link rel="prefetch" href="/assets/js/8.651698aa.js"><link rel="prefetch" href="/assets/js/9.fdd84905.js">
    <link rel="stylesheet" href="/assets/css/0.styles.65389751.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-19557b78><div data-v-19557b78><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-19557b78 data-v-19557b78><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-19557b78 data-v-19557b78><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>Shopee 供应链技术博客</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Shopee Supply Chain</span>
            
          <!---->
          2021
        </a></span></div></div> <div class="hide" data-v-19557b78><header class="navbar" data-v-19557b78><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/shopee.png" alt="Shopee 供应链技术博客" class="logo"> <span class="site-name">Shopee 供应链技术博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/database/" class="nav-link"><i class="iconfont undefined"></i>
  database
</a></li><li class="dropdown-item"><!----> <a href="/categories/CompilerTheory,Golang/" class="nav-link"><i class="iconfont undefined"></i>
  CompilerTheory,Golang
</a></li><li class="dropdown-item"><!----> <a href="/categories/MVCC/" class="nav-link"><i class="iconfont undefined"></i>
  MVCC
</a></li><li class="dropdown-item"><!----> <a href="/categories/golang/" class="nav-link"><i class="iconfont undefined"></i>
  golang
</a></li><li class="dropdown-item"><!----> <a href="/categories/Spark/" class="nav-link"><i class="iconfont undefined"></i>
  Spark
</a></li><li class="dropdown-item"><!----> <a href="/categories/CSS/" class="nav-link"><i class="iconfont undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/categories/efficiency/" class="nav-link"><i class="iconfont undefined"></i>
  efficiency
</a></li><li class="dropdown-item"><!----> <a href="/categories/Performance/" class="nav-link"><i class="iconfont undefined"></i>
  Performance
</a></li><li class="dropdown-item"><!----> <a href="/categories/http/" class="nav-link"><i class="iconfont undefined"></i>
  http
</a></li><li class="dropdown-item"><!----> <a href="/categories/react/" class="nav-link"><i class="iconfont undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/categories/Middleware/" class="nav-link"><i class="iconfont undefined"></i>
  Middleware
</a></li><li class="dropdown-item"><!----> <a href="/categories/Security/" class="nav-link"><i class="iconfont undefined"></i>
  Security
</a></li><li class="dropdown-item"><!----> <a href="/categories/git/" class="nav-link"><i class="iconfont undefined"></i>
  git
</a></li><li class="dropdown-item"><!----> <a href="/categories/Algorithm/" class="nav-link"><i class="iconfont undefined"></i>
  Algorithm
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-19557b78></div> <aside class="sidebar" data-v-19557b78><div class="personal-info-wrapper" data-v-b038cec6><img src="/shopee.png" alt="author-avatar" class="personal-img" data-v-b038cec6> <h3 class="name" data-v-b038cec6>
    Shopee Supply Chain
  </h3> <div class="num" data-v-b038cec6><div data-v-b038cec6><h3 data-v-b038cec6>17</h3> <h6 data-v-b038cec6>Article</h6></div> <div data-v-b038cec6><h3 data-v-b038cec6>17</h3> <h6 data-v-b038cec6>Tag</h6></div></div> <hr data-v-b038cec6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/database/" class="nav-link"><i class="iconfont undefined"></i>
  database
</a></li><li class="dropdown-item"><!----> <a href="/categories/CompilerTheory,Golang/" class="nav-link"><i class="iconfont undefined"></i>
  CompilerTheory,Golang
</a></li><li class="dropdown-item"><!----> <a href="/categories/MVCC/" class="nav-link"><i class="iconfont undefined"></i>
  MVCC
</a></li><li class="dropdown-item"><!----> <a href="/categories/golang/" class="nav-link"><i class="iconfont undefined"></i>
  golang
</a></li><li class="dropdown-item"><!----> <a href="/categories/Spark/" class="nav-link"><i class="iconfont undefined"></i>
  Spark
</a></li><li class="dropdown-item"><!----> <a href="/categories/CSS/" class="nav-link"><i class="iconfont undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/categories/efficiency/" class="nav-link"><i class="iconfont undefined"></i>
  efficiency
</a></li><li class="dropdown-item"><!----> <a href="/categories/Performance/" class="nav-link"><i class="iconfont undefined"></i>
  Performance
</a></li><li class="dropdown-item"><!----> <a href="/categories/http/" class="nav-link"><i class="iconfont undefined"></i>
  http
</a></li><li class="dropdown-item"><!----> <a href="/categories/react/" class="nav-link"><i class="iconfont undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/categories/Middleware/" class="nav-link"><i class="iconfont undefined"></i>
  Middleware
</a></li><li class="dropdown-item"><!----> <a href="/categories/Security/" class="nav-link"><i class="iconfont undefined"></i>
  Security
</a></li><li class="dropdown-item"><!----> <a href="/categories/git/" class="nav-link"><i class="iconfont undefined"></i>
  git
</a></li><li class="dropdown-item"><!----> <a href="/categories/Algorithm/" class="nav-link"><i class="iconfont undefined"></i>
  Algorithm
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>当前端聊安全时，前端在聊什么？</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/views/fe/security/what_we_are_talking_about_when_we_are_talking_about_web_security.html#web-安全对前端的重要性" class="sidebar-link">Web 安全对前端的重要性</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/fe/security/what_we_are_talking_about_when_we_are_talking_about_web_security.html#web-漏洞的几个大分类" class="sidebar-link">Web 漏洞的几个大分类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/fe/security/what_we_are_talking_about_when_we_are_talking_about_web_security.html#没有过滤输入或过滤不全" class="sidebar-link">没有过滤输入或过滤不全</a></li><li class="sidebar-sub-header"><a href="/views/fe/security/what_we_are_talking_about_when_we_are_talking_about_web_security.html#权限问题、配置问题" class="sidebar-link">权限问题、配置问题</a></li><li class="sidebar-sub-header"><a href="/views/fe/security/what_we_are_talking_about_when_we_are_talking_about_web_security.html#由人的不可靠性导致的问题" class="sidebar-link">由人的不可靠性导致的问题</a></li><li class="sidebar-sub-header"><a href="/views/fe/security/what_we_are_talking_about_when_we_are_talking_about_web_security.html#耗尽资源以影响正常业务" class="sidebar-link">耗尽资源以影响正常业务</a></li></ul></li><li><a href="/views/fe/security/what_we_are_talking_about_when_we_are_talking_about_web_security.html#树立正确的安全观" class="sidebar-link">树立正确的安全观</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/fe/security/what_we_are_talking_about_when_we_are_talking_about_web_security.html#为什么会出现这些漏洞" class="sidebar-link">为什么会出现这些漏洞</a></li><li class="sidebar-sub-header"><a href="/views/fe/security/what_we_are_talking_about_when_we_are_talking_about_web_security.html#question-time！" class="sidebar-link">Question Time！</a></li></ul></li><li><a href="/views/fe/security/what_we_are_talking_about_when_we_are_talking_about_web_security.html#参考资料" class="sidebar-link">参考资料</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-19557b78><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>当前端聊安全时，前端在聊什么？</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Shopee Supply Chain</span>
            
          <!---->
          2021
        </a></span></div></div> <div data-v-19557b78><main class="page"><div class="page-title" style="display:none;"><h1>当前端聊安全时，前端在聊什么？</h1> <hr> <div data-v-484a899e><i class="iconfont reco-account" data-v-484a899e><span data-v-484a899e>Rex</span></i> <i class="iconfont reco-date" data-v-484a899e><span data-v-484a899e>2020-12-07</span></i> <!----> <i class="iconfont reco-tag tags" data-v-484a899e><span class="tag-item" data-v-484a899e>
      Security
    </span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><h2 id="web-安全对前端的重要性"><a href="#web-安全对前端的重要性" class="header-anchor">#</a> Web 安全对前端的重要性</h2> <p>一提到 Web 安全，可能做前端的同学们会觉得：安全离我们很遥远吧，除了面试的时候问到的 XSS 和 CSRF 之外，似乎没有什么可以聊的了——毕竟，我们现在的开发基本都是用的 React、Vue 等框架，只要不手贱使用 <code>dangerouslySetInnerHTML</code> 或 <code>v-html</code> 那基本就没有 XSS 嘛！</p> <p>那么问题来了：如果业务需求必须要求我们展示用户生成的富文本，该如何防御 XSS？对于这个问题，有几种答案：</p> <ol><li>为敏感 Cookie 设置 <code>HttpOnly</code> 标记</li> <li>过滤掉用户输入中的 <code>alert</code>、<code>javascript</code> 等关键字</li> <li>让后端来做（面试官：嗯？）</li></ol> <p>虽然这些答案都是可行的，但完美的答案并不在这几个当中。作为一个写业务的人，我们不光需要考虑到攻击和防御方式，也要考虑这些攻击和防御对业务的影响有多大。例如过滤掉用户输入的做法，如果你在一个技术博客中留言：“在 JavaScript 中如何弹出对话框”，这句话中的“JavaScript”就会被上述简单的规则过滤掉。虽然这个规则成功的防御住了威胁，但也影响到了正常的业务。</p> <p>这只是一个简单的例子，事实上，即使是跟浏览器相关的安全问题，也远不止 XSS 和 CSRF 这两个。更何况，目前的前端发展趋势之一是“大前端”。当前端开始写 Node.JS 之后，是不是更需要考虑之前本不需要考虑的安全问题了呢？</p> <h2 id="web-漏洞的几个大分类"><a href="#web-漏洞的几个大分类" class="header-anchor">#</a> Web 漏洞的几个大分类</h2> <p>对于常见的 Web 漏洞，我觉得可以大致分为这几类：</p> <ol><li>没有过滤输入或过滤不全</li> <li>权限问题、配置问题</li> <li>由人的不可靠性导致的问题</li> <li>耗尽资源以影响正常业务</li></ol> <p>其中，前两条在 CTF（安全竞赛中的赛制之一：夺旗赛）的 Web 题目中大量出现，第四条在现实世界中出现的频率稍微高一些，而第三条往往更需要引起开发者们的重视，因为——</p> <blockquote><p>在全部违规活动中，网络钓鱼与社会工程占 55%，内部恶意人员违规占 13%，远程访问占 9%。人为因素仍是企业网络安全团队所面临的最大障碍。[1]</p></blockquote> <p>我花了一段时间，对这几类漏洞进行了一些思考。</p> <h3 id="没有过滤输入或过滤不全"><a href="#没有过滤输入或过滤不全" class="header-anchor">#</a> 没有过滤输入或过滤不全</h3> <p>可能大家都听说过近 20 年来最著名的漏洞之一：SQL 注入，也可能听说过一个小游戏：<a href="https://alf.nu/alert1" target="_blank" rel="noopener noreferrer">alert(1) to win<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，这些都属于第一类漏洞，即没有过滤输入或过滤不全。这类漏洞有一个通用的特征：拼接了用户的输入，用户的输入中有恶意代码，恶意代码在各种地方被执行。</p> <p>看这篇文章的大部分同学可能是前端，因此就用前端的著名漏洞 XSS 来引入吧。XSS 的基础例子很简单：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/hello/:user'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> user <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text/html'</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1&gt;Hello, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!&lt;/h1&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>当我们访问 <code>/hello/rex</code> 的时候，页面会展示“Hello, rex!”，但是如果我们把地址中的 <code>rex</code> 换成这些（需要转译部分符号），事情就变得有意思起来了：</p> <ul><li><code>&lt;script&gt;alert(1)&lt;/script&gt;</code></li> <li><code>&lt;script src=&quot;//t.cn/x&quot;&gt;&lt;/script&gt;</code></li> <li><code>&lt;img src=# onerror=alert(1)&gt;</code></li> <li><code>&lt;img onload=alert(1)&gt;</code></li></ul> <p>大家应该能猜出来这会导致什么。要么是弹出来一个框，要么是执行了一段外部脚本。</p> <p>事实上，XSS 有三种，刚刚的例子叫“反射型 XSS”，另外两种叫“存储型 XSS”和“DOM Based XSS”。但是本质是一样的——用户通过某些方式提交了恶意代码，并且这些恶意代码在客户端（大多数情况下是浏览器）被执行了。</p> <ul><li>SQL 注入的本质跟 XSS 也是几乎一样的：用户通过某些方式提交了恶意代码，并且这些恶意代码在数据库实例上被执行了。</li> <li>重定向攻击的本质跟 XSS 也是几乎一样的：用户通过某些方式提交了一个恶意网址，系统接受了这个恶意网址并把用户跳转了过去。</li> <li>代码执行漏洞的本质跟 XSS 也是几乎一样的：用户通过某些方式提交了恶意代码，并且这些恶意代码在后端实例上被执行了。</li> <li>任意文件上传的本质……（被打</li></ul> <p>通过这些例子，大家应该大致了解了“没有过滤输入或过滤不全”的含义了。那么具体该如何防御呢？首先如果不考虑富文本业务的话，可以简单的应用一系列规则。还是以 XSS 为例：</p> <ul><li>过滤掉所有的 <code>&lt;</code> 等符号</li> <li>禁止使用 <code>v-html</code> 等方法，禁止设置 <code>innerHTML</code></li></ul> <p>那么必须使用富文本的情况呢？没关系，还有其它方式：</p> <ul><li>必须使用 <code>innerHTML</code> 的情况下可以用成熟的 HTML parsing 库，遍历一遍，用白名单来过滤标签和属性</li> <li>可以使用 CSP 来限制外部代码的加载和内联代码的执行（问题延伸：如何设置 CSP 才是合理的？）</li></ul> <p>那么必须允许执行 JavaScript 的情况呢？</p> <p>遇到瓶颈了。这时候，经验丰富的大佬（或者 CTF 中的 PHP 老手）会想到，我们可以替换一些危险函数为空函数，例如 <code>alert</code>、<code>eval</code>、<code>fetch</code> 等（在我们自己的模块闭包中需要保存一份 <code>window</code> 中的这些方法）。但是 XSS 的危害不止一种，虽然黑客不能发送 Cookie 到指定服务器了，但它可以修改页面元素，可以将用户跳转到黑客自己的恶意页面（不要笑，只要用户基数足够大，一定有小白用户会上当），甚至可以获取存在 Cookie 中的 CSRF Token 并代替用户发请求（这样你的 CSRF 防御就失效了）。</p> <p>当然，一般情况下我们遇不到这么复杂的业务场景。但是这已经足够说明一件事情：即使是一个被大家熟知的漏洞，在某些情况下，想防御好也是需要了解业务的。</p> <h3 id="权限问题、配置问题"><a href="#权限问题、配置问题" class="header-anchor">#</a> 权限问题、配置问题</h3> <p>先来看几个漏洞：</p> <ul><li>部分 API 没有校验登录（多见于 PHP 工程）：一些传统的项目中，不同的 URL 是由不同文件 Handle 的，可能有的文件一开始写了鉴权的代码，但有的文件没有</li> <li>微服务未做鉴权：目前微服务是后端的一个方向，如果一个微服务在开发时为了方便而没有做鉴权，恰好 URL 是对外网暴露的，这个 API 就可以被直接调用</li> <li>用户权限配置不当：辖区管理员可以修改普通账号的密码，那能否修改超级管理员的密码呢</li> <li>网上随处可见的 MongoDB 数据泄露、ES 数据泄露，原因竟然都是因为它们的默认密码是空密码</li> <li>通过网站上暴露的 <code>.git</code> 和 <code>.svn</code> 目录，可以直接恢复整个 Git 仓库</li></ul> <p><img src="https://camo.githubusercontent.com/c221eb577ebfef5e5037bfb6afab710814a958122a1385db8159a3182f895313/68747470733a2f2f69302e77702e636f6d2f7777772e68617a7a656c2e636e2f77702d636f6e74656e742f75706c6f6164732f323031392f30342f53637265656e2d53686f742d323031392d30342d32312d61742d31312e34342e34392d504d2e706e673f73736c3d31" alt="可以恢复整个 Git 仓库的 Git Hack 工具"></p> <p>这些漏洞看似各有各的解决方案，有的需要统一入口，有的需要请第三方审计人员帮忙，有的需要设置禁止访问的目录……但是这些漏洞是否也有一些本质上的共同点呢？我认为是有的，当某一个决策（可能是一行配置信息，可能是一个业务需求）会导致一些本来没有权限的人能看到他们不该看的东西，权限和配置漏洞就形成了。</p> <p>针对这类问题，其实有一句大家耳熟能详的话：“最小权限原则”，相信大家都知道这是什么意思。但是真正去执行它的人有多少呢？假设我们要起一个内部系统，上层的规定是不是“快速交付，权限问题先放松一下”；假设有个运营平台，产品经理配置的角色是不是常常会出现“All Permissions”的字样？在写 SQL 返回用户信息时，我们会不会写 <code>SELECT * FROM users LIMIT xxx</code> 而忽略了 <code>users</code> 表中其实保存了用户的密码哈希？</p> <p>这类漏洞告诉我的一个经验是：即使是一句简单的话，想要执行起来，通常也是十分困难的。</p> <h3 id="由人的不可靠性导致的问题"><a href="#由人的不可靠性导致的问题" class="header-anchor">#</a> 由人的不可靠性导致的问题</h3> <p>“人是最不可靠的”，这句话经常出现在社会工程学的教学文章中。目前的网络攻击一半以上也是社会工程学。对于社会工程学的防护，网上的教程有很多，一般人只需要做到一些常见的措施，提升攻击成本，就已经足够保证安全了，因为对于黑客来说，只要攻击一个人的成本比获得的收益还要高，那么这个攻击就是不值得的。</p> <p>但是企业是一个特殊的实体，在大部分情况下，攻击企业的收益比个人高多了。由于人的不可靠性，只要有一个可执行的攻击方式，就一定会有人中招。因此一些企业会定期做安全培训，甚至模拟黑客发送病毒邮件，只要点开就会被强制接受安全教育。对于企业的安全教育，网上也有一些文章，这里就不多提了。</p> <p>有一个比较有趣的剧：《人生删除事务所》，里面有很多社会工程学的教程。</p> <blockquote><p>这简直是部社会工程学教科书式教学啊。留后门方便查数据；打电话玩 cosplay 套信息，套密码；社工搜资料用 python 脚本生成字典，暴力猜密码；警察局的电脑资料怎么弄到？直接演戏混进去拆硬盘！[2]</p></blockquote> <p><img src="https://user-images.githubusercontent.com/27483702/101334129-6a149500-38b2-11eb-9587-c4569d4cbe9c.png" alt="《人生删除事务所》片段"></p> <h3 id="耗尽资源以影响正常业务"><a href="#耗尽资源以影响正常业务" class="header-anchor">#</a> 耗尽资源以影响正常业务</h3> <p>对于这类漏洞，最常见的就是 DoS/DDoS 了。至于这类漏洞的成因，其实也是有共性的——在处理某些逻辑的时候没有考虑到可能的流量峰值，以及业务的异常情况。从技术的角度来讲，这类漏洞的技术细节五花八门：</p> <ul><li>使用了可能会导致慢查询的 ORM 库</li> <li>对外部依赖的调用时长未做限制，导致流量峰值时连接数过多</li> <li>正则表达式在回溯时产生的性能问题</li> <li>读写文件时忘记关闭文件，导致同时打开的文件句柄过多</li> <li>错误的将大型对象放到了全局作用域，导致缓慢的内存泄漏</li></ul> <p>这就要求我们做到三点，一是在技术的选型中，需要考虑这个技术的成熟度、发生风险时修复的难度（社区活跃度是个很好的指标）；二是在平时编码的过程中，需要有一定的压力测试；三是从公司层面上需要有定期的培训，尽量避免新人写出可以耗尽资源的代码。</p> <h2 id="树立正确的安全观"><a href="#树立正确的安全观" class="header-anchor">#</a> 树立正确的安全观</h2> <p>挖洞补洞是安全人员必须的工作，但是作为非安全方向的开发者，我们也需要树立正确的安全观。</p> <h3 id="为什么会出现这些漏洞"><a href="#为什么会出现这些漏洞" class="header-anchor">#</a> 为什么会出现这些漏洞</h3> <p>最表象的原因当然是开发者写代码的时候没有考虑到安全问题。如果只出现一两次，可以说是偶然，但现在国内国外有各种各样的信息泄漏事件：</p> <ul><li><a href="https://zh.wikipedia.org/zh-hans/2011%E5%B9%B4%E4%B8%AD%E5%9B%BD%E7%BD%91%E7%AB%99%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E4%BA%8B%E4%BB%B6" target="_blank" rel="noopener noreferrer">2011 年中国网站用户信息泄露事件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://twitter.com/0xdude/status/1095702540463820800" target="_blank" rel="noopener noreferrer">2019 年深网视界数据泄漏事件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.oschina.net/news/103558/202-million-private-resumes-exposed" target="_blank" rel="noopener noreferrer">MongoDB 裸奔，2 亿国人求职简历泄漏<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.infoq.cn/article/dG1lUq*1FMWKDoi7tjkH" target="_blank" rel="noopener noreferrer">Facebook 6 亿用户密码可被 2 万员工直接看<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://www.xinhuanet.com/fortune/2018-08/29/c_1123343927.htm" target="_blank" rel="noopener noreferrer">华住 5 亿条用户信息疑泄露<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.zdnet.com/article/hacker-ransoms-23k-mongodb-databases-and-threatens-to-contact-gdpr-authorities/" target="_blank" rel="noopener noreferrer">黑客清除并勒索 23k 个 MongoDB 数据库<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>……以及网络攻击事件。其中不乏 Facebook、新浪这样的大公司，这真的只有开发者的原因吗？</p> <p>其实想一想，安全事故其实也是一类事故，那么抛开技术的差异性，其出现的原因跟其它事故没有太大的区别。海恩法则指出：</p> <blockquote><p>每一起严重事故的背后，必然有 29 次轻微事故，300 起未遂先兆，以及 1000 起事故隐患。[3]</p></blockquote> <p>海恩法则是航空界关于飞行安全的法则。飞机之所以会成为最安全的交通工具，就是由于积累了一系列事故经验，并总结成了各种规章制度和培训机制。然而，对于普通公司和个人来说，要想做到这些又谈何容易：</p> <ul><li>大多数中小公司因为成本原因，没有专门的安全岗位</li> <li>大部分普通人平时没有很强的安全意识，为了便利可以交出很多东西</li> <li>国家虽然制定了《网络安全法》等法律，但向大众普及信息安全知识的力度远远不够</li></ul> <p>当然也有一些值得欣慰的东西。“白帽子”是一类特殊的安全工作者，有的是专业安全团队的成员，有的是黑客出身但最终决定转型帮助社会建立安全的环境。<a href="https://www.zhihu.com/question/58093923" target="_blank" rel="noopener noreferrer">2016 年乌云漏洞报告平台被关闭<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是一个很可惜的事情，但现在国内的漏洞报告厂商纷纷上线了《白帽子协议》，对白帽子的行为进行了授权，给了他们更多的生存空间。在这群特殊的安全人员的保护下，很多简单的漏洞可以被及时封堵，这会大大提高网络攻击的困难程度。信息安全，任重道远。</p> <h3 id="question-time！"><a href="#question-time！" class="header-anchor">#</a> Question Time！</h3> <p>最后，就用这十道题目，来检验一下你的安全意识吧！</p> <ol><li>很多专业黑客都有大量的知识与工具，他们攻击一个大型的公司简直易如反掌。</li> <li>我们普通人没有什么水平，对自身的数据泄露无能为力，只能依赖于专业安全人员的保护。</li> <li>我们都是底层群众，公司也是小公司，黑客不会专门盯着我们来攻击，因此我们很安全。</li> <li>即使一个网站代码简单到几乎不可能有漏洞，但运营人员依旧需要有很强的安全意识。</li> <li>我使用所有能找到的工具扫描了我的网站，并修复了所有安全隐患，但我依旧不能掉以轻心。</li> <li>我遇到了一个钓鱼网站，心想“反正它是非法网站”，于是便找出工具打算“为民除害”。</li> <li>公司必须对所有员工做基本的安全培训，并在成本可控的范围内实行各种措施来加强安全。</li> <li>在一次非常不重要的在线测试中，我发现了系统的一个漏洞，并决定用它获取所有正确答案。</li> <li>我负责的系统有个很不起眼的漏洞，但该系统只能从公司内网访问，所以用不着费时间修复。</li> <li>我爸喜欢用 1234 作为解锁密码，作为一个接受了安全培训的人，我坚持让他换成了指纹密码。</li></ol> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <ul><li>[1] <a href="https://www.secrss.com/articles/5498" target="_blank" rel="noopener noreferrer">全球网络安全事件十大趋势总结 - 安全内参 | 决策者的网络安全知识库<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>[2] <a href="https://twitter.com/lcayu/status/1025812731314630656" target="_blank" rel="noopener noreferrer">Lanpice 的推文<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>[3] <a href="https://wiki.mbalib.com/wiki/%E6%B5%B7%E6%81%A9%E6%B3%95%E5%88%99" target="_blank" rel="noopener noreferrer">海恩法则 - MBA 智库百科<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit" style="display:none;"><!----> <!----></footer> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-44bd5a18 data-v-44bd5a18><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-44bd5a18><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-44bd5a18></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-44bd5a18></path></svg></div></div></div>
    <script src="/assets/js/app.89d7a7af.js" defer></script><script src="/assets/js/3.39c0dfdf.js" defer></script><script src="/assets/js/1.fc4f2573.js" defer></script><script src="/assets/js/28.7b9ee58e.js" defer></script>
  </body>
</html>
