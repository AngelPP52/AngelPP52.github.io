<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>go modules实践中的问题 | Shopee 供应链技术博客</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Share Our Knowledge.">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/assets/css/0.styles.65389751.css" as="style"><link rel="preload" href="/assets/js/app.89d7a7af.js" as="script"><link rel="preload" href="/assets/js/3.39c0dfdf.js" as="script"><link rel="preload" href="/assets/js/1.fc4f2573.js" as="script"><link rel="preload" href="/assets/js/10.8f886ff6.js" as="script"><link rel="prefetch" href="/assets/js/11.42709e7b.js"><link rel="prefetch" href="/assets/js/12.51c95e33.js"><link rel="prefetch" href="/assets/js/13.a7db2e06.js"><link rel="prefetch" href="/assets/js/14.b9fd5312.js"><link rel="prefetch" href="/assets/js/15.02f2a353.js"><link rel="prefetch" href="/assets/js/16.f2b3bba4.js"><link rel="prefetch" href="/assets/js/17.fa6f4a21.js"><link rel="prefetch" href="/assets/js/18.cc202cb1.js"><link rel="prefetch" href="/assets/js/19.b74d740a.js"><link rel="prefetch" href="/assets/js/20.4f1350b1.js"><link rel="prefetch" href="/assets/js/21.7011a4c9.js"><link rel="prefetch" href="/assets/js/22.71907870.js"><link rel="prefetch" href="/assets/js/23.7ea72b1e.js"><link rel="prefetch" href="/assets/js/24.156af4ed.js"><link rel="prefetch" href="/assets/js/25.705d13d1.js"><link rel="prefetch" href="/assets/js/26.90da6739.js"><link rel="prefetch" href="/assets/js/27.a1d9dc04.js"><link rel="prefetch" href="/assets/js/28.7b9ee58e.js"><link rel="prefetch" href="/assets/js/29.c14786fa.js"><link rel="prefetch" href="/assets/js/30.cc235e35.js"><link rel="prefetch" href="/assets/js/4.d90b791b.js"><link rel="prefetch" href="/assets/js/5.16307cd7.js"><link rel="prefetch" href="/assets/js/6.3a371881.js"><link rel="prefetch" href="/assets/js/7.40292f84.js"><link rel="prefetch" href="/assets/js/8.651698aa.js"><link rel="prefetch" href="/assets/js/9.fdd84905.js">
    <link rel="stylesheet" href="/assets/css/0.styles.65389751.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-19557b78><div data-v-19557b78><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-19557b78 data-v-19557b78><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-19557b78 data-v-19557b78><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>Shopee 供应链技术博客</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Shopee Supply Chain</span>
            
          <!---->
          2021
        </a></span></div></div> <div class="hide" data-v-19557b78><header class="navbar" data-v-19557b78><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/shopee.png" alt="Shopee 供应链技术博客" class="logo"> <span class="site-name">Shopee 供应链技术博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/database/" class="nav-link"><i class="iconfont undefined"></i>
  database
</a></li><li class="dropdown-item"><!----> <a href="/categories/CompilerTheory,Golang/" class="nav-link"><i class="iconfont undefined"></i>
  CompilerTheory,Golang
</a></li><li class="dropdown-item"><!----> <a href="/categories/MVCC/" class="nav-link"><i class="iconfont undefined"></i>
  MVCC
</a></li><li class="dropdown-item"><!----> <a href="/categories/golang/" class="nav-link"><i class="iconfont undefined"></i>
  golang
</a></li><li class="dropdown-item"><!----> <a href="/categories/Spark/" class="nav-link"><i class="iconfont undefined"></i>
  Spark
</a></li><li class="dropdown-item"><!----> <a href="/categories/CSS/" class="nav-link"><i class="iconfont undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/categories/efficiency/" class="nav-link"><i class="iconfont undefined"></i>
  efficiency
</a></li><li class="dropdown-item"><!----> <a href="/categories/Performance/" class="nav-link"><i class="iconfont undefined"></i>
  Performance
</a></li><li class="dropdown-item"><!----> <a href="/categories/http/" class="nav-link"><i class="iconfont undefined"></i>
  http
</a></li><li class="dropdown-item"><!----> <a href="/categories/react/" class="nav-link"><i class="iconfont undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/categories/Middleware/" class="nav-link"><i class="iconfont undefined"></i>
  Middleware
</a></li><li class="dropdown-item"><!----> <a href="/categories/Security/" class="nav-link"><i class="iconfont undefined"></i>
  Security
</a></li><li class="dropdown-item"><!----> <a href="/categories/git/" class="nav-link"><i class="iconfont undefined"></i>
  git
</a></li><li class="dropdown-item"><!----> <a href="/categories/Algorithm/" class="nav-link"><i class="iconfont undefined"></i>
  Algorithm
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-19557b78></div> <aside class="sidebar" data-v-19557b78><div class="personal-info-wrapper" data-v-b038cec6><img src="/shopee.png" alt="author-avatar" class="personal-img" data-v-b038cec6> <h3 class="name" data-v-b038cec6>
    Shopee Supply Chain
  </h3> <div class="num" data-v-b038cec6><div data-v-b038cec6><h3 data-v-b038cec6>17</h3> <h6 data-v-b038cec6>Article</h6></div> <div data-v-b038cec6><h3 data-v-b038cec6>17</h3> <h6 data-v-b038cec6>Tag</h6></div></div> <hr data-v-b038cec6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/database/" class="nav-link"><i class="iconfont undefined"></i>
  database
</a></li><li class="dropdown-item"><!----> <a href="/categories/CompilerTheory,Golang/" class="nav-link"><i class="iconfont undefined"></i>
  CompilerTheory,Golang
</a></li><li class="dropdown-item"><!----> <a href="/categories/MVCC/" class="nav-link"><i class="iconfont undefined"></i>
  MVCC
</a></li><li class="dropdown-item"><!----> <a href="/categories/golang/" class="nav-link"><i class="iconfont undefined"></i>
  golang
</a></li><li class="dropdown-item"><!----> <a href="/categories/Spark/" class="nav-link"><i class="iconfont undefined"></i>
  Spark
</a></li><li class="dropdown-item"><!----> <a href="/categories/CSS/" class="nav-link"><i class="iconfont undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/categories/efficiency/" class="nav-link"><i class="iconfont undefined"></i>
  efficiency
</a></li><li class="dropdown-item"><!----> <a href="/categories/Performance/" class="nav-link"><i class="iconfont undefined"></i>
  Performance
</a></li><li class="dropdown-item"><!----> <a href="/categories/http/" class="nav-link"><i class="iconfont undefined"></i>
  http
</a></li><li class="dropdown-item"><!----> <a href="/categories/react/" class="nav-link"><i class="iconfont undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/categories/Middleware/" class="nav-link"><i class="iconfont undefined"></i>
  Middleware
</a></li><li class="dropdown-item"><!----> <a href="/categories/Security/" class="nav-link"><i class="iconfont undefined"></i>
  Security
</a></li><li class="dropdown-item"><!----> <a href="/categories/git/" class="nav-link"><i class="iconfont undefined"></i>
  git
</a></li><li class="dropdown-item"><!----> <a href="/categories/Algorithm/" class="nav-link"><i class="iconfont undefined"></i>
  Algorithm
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>go modules实践中的问题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/views/be/go/go_modules/go_modules.html#写在最前" class="sidebar-link">写在最前</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/be/go/go_modules/go_modules.html#go-modules基本使用" class="sidebar-link">go modules基本使用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/be/go/go_modules/go_modules.html#go-modules环境变量" class="sidebar-link">go modules环境变量</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/be/go/go_modules/go_modules.html#go111module" class="sidebar-link">GO111MODULE</a></li><li class="sidebar-sub-header"><a href="/views/be/go/go_modules/go_modules.html#goproxy" class="sidebar-link">GOPROXY</a></li><li class="sidebar-sub-header"><a href="/views/be/go/go_modules/go_modules.html#gosumdb" class="sidebar-link">GOSUMDB</a></li><li class="sidebar-sub-header"><a href="/views/be/go/go_modules/go_modules.html#gonoproxy-gonosumdb-goprivate" class="sidebar-link">GONOPROXY/GONOSUMDB/GOPRIVATE</a></li></ul></li><li><a href="/views/be/go/go_modules/go_modules.html#go-modules版本选择" class="sidebar-link">go modules版本选择</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/be/go/go_modules/go_modules.html#语义化版本控制" class="sidebar-link">语义化版本控制</a></li><li class="sidebar-sub-header"><a href="/views/be/go/go_modules/go_modules.html#导入兼容性规则" class="sidebar-link">导入兼容性规则</a></li><li class="sidebar-sub-header"><a href="/views/be/go/go_modules/go_modules.html#最小版本选择" class="sidebar-link">最小版本选择</a></li></ul></li><li><a href="/views/be/go/go_modules/go_modules.html#案例分析" class="sidebar-link">案例分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/be/go/go_modules/go_modules.html#case-1" class="sidebar-link">case 1</a></li></ul></li><li><a href="/views/be/go/go_modules/go_modules.html#小结" class="sidebar-link">小结</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/be/go/go_modules/go_modules.html#一些go-modules的使用建议" class="sidebar-link">一些go modules的使用建议</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/be/go/go_modules/go_modules.html#参考文章" class="sidebar-link">参考文章</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-19557b78><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>go modules实践中的问题</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Shopee Supply Chain</span>
            
          <!---->
          2021
        </a></span></div></div> <div data-v-19557b78><main class="page"><div class="page-title" style="display:none;"><h1>go modules实践中的问题</h1> <hr> <div data-v-484a899e><i class="iconfont reco-account" data-v-484a899e><span data-v-484a899e>weiyi.he</span></i> <i class="iconfont reco-date" data-v-484a899e><span data-v-484a899e>2020-11-22</span></i> <!----> <i class="iconfont reco-tag tags" data-v-484a899e><span class="tag-item" data-v-484a899e>
      modules
    </span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><h2 id="写在最前"><a href="#写在最前" class="header-anchor">#</a> 写在最前</h2> <p>因为网上关于go modules的文章已经非常多了，而且讲得也非常详细，所以本文只会大概介绍一下go modules中比较重要的几个点(如果大家想深入了解go modules，可以参考<a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0">这里</a>)，剩下的篇幅会列举在工程开发上使用go modules所遇到的问题，以及我们是如何解决的；最后会总结出一些关于go modules的使用建议。</p> <br> <h2 id="go-modules基本使用"><a href="#go-modules基本使用" class="header-anchor">#</a> go modules基本使用</h2> <table><thead><tr><th style="text-align:center;">命令</th> <th style="text-align:center;">作用</th></tr></thead> <tbody><tr><td style="text-align:center;">go mod init</td> <td style="text-align:center;">生成 go.mod 文件</td></tr> <tr><td style="text-align:center;">go mod download</td> <td style="text-align:center;">下载 go.mod 文件中指明的所有依赖</td></tr> <tr><td style="text-align:center;">go mod tidy</td> <td style="text-align:center;">整理现有的依赖</td></tr> <tr><td style="text-align:center;">go mod graph</td> <td style="text-align:center;">查看现有的依赖结构</td></tr> <tr><td style="text-align:center;">go mod edit</td> <td style="text-align:center;">编辑 go.mod 文件</td></tr> <tr><td style="text-align:center;">go mod vendor</td> <td style="text-align:center;">导出项目所有的依赖到vendor目录</td></tr> <tr><td style="text-align:center;">go mod verify</td> <td style="text-align:center;">校验一个模块是否被篡改过</td></tr> <tr><td style="text-align:center;">go mod why</td> <td style="text-align:center;">查看为什么需要依赖某模块</td></tr></tbody></table> <br> <h2 id="go-modules环境变量"><a href="#go-modules环境变量" class="header-anchor">#</a> go modules环境变量</h2> <br> <h3 id="go111module"><a href="#go111module" class="header-anchor">#</a> GO111MODULE</h3> <ul><li>auto：只要项目包含了 go.mod 文件的话启用 Go modules，目前在 Go1.11 至 Go1.14 中仍然是默认值；</li> <li>on：启用 Go modules，推荐设置，将会是未来版本中的默认值；</li> <li>off：禁用 Go modules，不推荐设置；</li></ul> <br> <h3 id="goproxy"><a href="#goproxy" class="header-anchor">#</a> GOPROXY</h3> <ul><li><p>这个环境变量主要是用于设置 Go 模块代理，其作用是用于使 Go 在后续拉取模块版本时能够脱离传统的 VCS 方式，直接通过镜像站点来快速拉取;</p></li> <li><p>GOPROXY 的默认值是: <strong>https://proxy.golang.org,direct</strong>，但是在国内是无法访问<strong>proxy.golang.org</strong>的，所以这里可以设置为国内的代理：</p></li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code>$ <span class="token keyword">go</span> env <span class="token operator">-</span>w GOPROXY<span class="token operator">=</span>https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>goproxy<span class="token punctuation">.</span>cn<span class="token punctuation">,</span>direct
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><br> <h3 id="gosumdb"><a href="#gosumdb" class="header-anchor">#</a> GOSUMDB</h3> <ul><li><p>它的值是一个 Go checksum database，用于在拉取模块版本时（无论是从源站拉取还是通过 Go module proxy 拉取）保证拉取到的模块版本数据未经过篡改，若发现不一致，也就是可能存在篡改，将会立即中止。</p></li> <li><p>GOSUMDB 的默认值为：<strong>sum.golang.org</strong>，在国内也是无法访问的，但是 GOSUMDB 可以被GOPROXY所代理；</p></li></ul> <br> <h3 id="gonoproxy-gonosumdb-goprivate"><a href="#gonoproxy-gonosumdb-goprivate" class="header-anchor">#</a> GONOPROXY/GONOSUMDB/GOPRIVATE</h3> <ul><li><p>这三个环境变量都是用在当前项目依赖了私有模块，例如像是你公司的私有 git 仓库，又或是 github 中的私有库，都是属于私有模块，都是要进行设置的，否则会拉取失败；</p></li> <li><p>GOPRIVATE的值将作为 GONOPROXY 和 GONOSUMDB 的默认值，所以可以直接使用GOPRIVATE；例如：</p></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ go env -w GOPRIVATE=&quot;git.example.com,github.com/eddycjy/mquote&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>设置后，前缀为git.example.com和github.com/eddycjy/mquote 的模块都会被认为是私有模块，不会参与代理和校验；</li></ul> <br> <h2 id="go-modules版本选择"><a href="#go-modules版本选择" class="header-anchor">#</a> go modules版本选择</h2> <h3 id="语义化版本控制"><a href="#语义化版本控制" class="header-anchor">#</a> 语义化版本控制</h3> <p><img src="/assets/img/semantic_version.113eff80.png" alt=""></p> <p>其版本格式为 “主版本号.次版本号.修订号”，版本号的递增规则如下：</p> <ol><li>主版本号：引入不兼容的 API 修改。</li> <li>次版本号：向下兼容的功能性新增。</li> <li>修订号：向下兼容的问题修正。</li></ol> <h3 id="导入兼容性规则"><a href="#导入兼容性规则" class="header-anchor">#</a> 导入兼容性规则</h3> <ul><li><p>Go modules在主版本号为 v0 和 v1 的情况下省略了版本号，并且保证向下兼容；</p></li> <li><p>而在主版本号为v2及以上则需要明确指定出主版本号，表示其引入不兼容的修改；</p></li> <li><p>tag与模块导入路径的大致对应关系如下：</p></li></ul> <table><thead><tr><th style="text-align:left;">tag</th> <th style="text-align:left;">模块导入路径</th></tr></thead> <tbody><tr><td style="text-align:left;">v0.0.0</td> <td style="text-align:left;">github.com/eddycjy/mquote</td></tr> <tr><td style="text-align:left;">v1.0.0</td> <td style="text-align:left;">github.com/eddycjy/mquote</td></tr> <tr><td style="text-align:left;">v2.0.0</td> <td style="text-align:left;">github.com/eddycjy/mquote/v2</td></tr> <tr><td style="text-align:left;">v3.0.0</td> <td style="text-align:left;">github.com/eddycjy/mquote/v3</td></tr></tbody></table> <br> <h3 id="最小版本选择"><a href="#最小版本选择" class="header-anchor">#</a> 最小版本选择</h3> <ul><li>'最小版本选择'这个命名获取有点让人产生歧义，我们可以大致理解为选择'最新非最大'的版本的算法；</li> <li>它定义了如下版本选择的算法：</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>To construct the build list for a given target: start the list with the target itself, and then append each requirement's own build list. If a module appears in the list multiple times, keep only the newest version.

To upgrade all modules to their latest versions: construct the build list, but read each requirement as if it requested the latest module version.

To upgrade one module to a specific newer version: construct the non-upgraded build list and then append the new module's build list. If a module appears in the list multiple times, keep only the newest version.

To downgrade one module to a specific older version: rewind the required version of each top-level requirement until that requirement's build list no longer refers to newer versions of the downgraded module.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="/assets/img/minimal_version_select.b7b27494.png" alt=""></p> <br> <h2 id="案例分析"><a href="#案例分析" class="header-anchor">#</a> 案例分析</h2> <h3 id="case-1"><a href="#case-1" class="header-anchor">#</a> case 1</h3> <ul><li>执行<strong>go mod download</strong>没有报错；</li> <li>执行<strong>go mod tidy -v</strong>命令会出现如下错误：</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">go</span><span class="token punctuation">:</span> finding module <span class="token keyword">for</span> <span class="token keyword">package</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>security<span class="token operator">/</span>plugins<span class="token operator">/</span>aes
<span class="token keyword">go</span><span class="token punctuation">:</span> found github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>security<span class="token operator">/</span>plugins<span class="token operator">/</span>aes in github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis v1<span class="token punctuation">.</span><span class="token number">8.3</span>
<span class="token keyword">go</span><span class="token punctuation">:</span> finding module <span class="token keyword">for</span> <span class="token keyword">package</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>middleware<span class="token operator">/</span>ratelimiter
<span class="token keyword">go</span><span class="token punctuation">:</span> finding module <span class="token keyword">for</span> <span class="token keyword">package</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>server<span class="token operator">/</span>restful<span class="token operator">/</span>api
<span class="token keyword">go</span><span class="token punctuation">:</span> finding module <span class="token keyword">for</span> <span class="token keyword">package</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>pkg<span class="token operator">/</span>profile
git<span class="token punctuation">.</span>garena<span class="token punctuation">.</span>com<span class="token operator">/</span>shopee<span class="token operator">/</span>bg<span class="token operator">-</span>logistics<span class="token operator">/</span>b2c<span class="token operator">/</span>sbs<span class="token operator">-</span>fbs<span class="token operator">-</span>server<span class="token operator">/</span>agent<span class="token operator">/</span>awb imports
        git<span class="token punctuation">.</span>garena<span class="token punctuation">.</span>com<span class="token operator">/</span>shopee<span class="token operator">/</span>bg<span class="token operator">-</span>logistics<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">/</span>chassis imports
        github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>middleware<span class="token operator">/</span>ratelimiter<span class="token punctuation">:</span> module github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis@latest found <span class="token punctuation">(</span>v1<span class="token punctuation">.</span><span class="token number">8.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> but does not contain <span class="token keyword">package</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>middleware<span class="token operator">/</span>ratelimiter
git<span class="token punctuation">.</span>garena<span class="token punctuation">.</span>com<span class="token operator">/</span>shopee<span class="token operator">/</span>bg<span class="token operator">-</span>logistics<span class="token operator">/</span>b2c<span class="token operator">/</span>sbs<span class="token operator">-</span>fbs<span class="token operator">-</span>server<span class="token operator">/</span>apps<span class="token operator">/</span>async_task<span class="token operator">/</span>schema imports
        git<span class="token punctuation">.</span>garena<span class="token punctuation">.</span>com<span class="token operator">/</span>shopee<span class="token operator">/</span>bg<span class="token operator">-</span>logistics<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">/</span>chassis<span class="token operator">/</span>protocol<span class="token operator">/</span>server<span class="token operator">/</span>restful imports
        github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>pkg<span class="token operator">/</span>profile<span class="token punctuation">:</span> module github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis@latest found <span class="token punctuation">(</span>v1<span class="token punctuation">.</span><span class="token number">8.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> but does not contain <span class="token keyword">package</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>pkg<span class="token operator">/</span>profile
git<span class="token punctuation">.</span>garena<span class="token punctuation">.</span>com<span class="token operator">/</span>shopee<span class="token operator">/</span>bg<span class="token operator">-</span>logistics<span class="token operator">/</span>b2c<span class="token operator">/</span>sbs<span class="token operator">-</span>fbs<span class="token operator">-</span>server<span class="token operator">/</span>apps<span class="token operator">/</span>async_task<span class="token operator">/</span>schema imports
        git<span class="token punctuation">.</span>garena<span class="token punctuation">.</span>com<span class="token operator">/</span>shopee<span class="token operator">/</span>bg<span class="token operator">-</span>logistics<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">/</span>chassis<span class="token operator">/</span>protocol<span class="token operator">/</span>server<span class="token operator">/</span>restful imports
        github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>server<span class="token operator">/</span>restful<span class="token operator">/</span>api<span class="token punctuation">:</span> module github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis@latest found <span class="token punctuation">(</span>v1<span class="token punctuation">.</span><span class="token number">8.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> but does not contain <span class="token keyword">package</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>server<span class="token operator">/</span>restful<span class="token operator">/</span>api
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="初步分析"><a href="#初步分析" class="header-anchor">#</a> 初步分析</h4> <ul><li><p>从上面错误信息可以得知，主要是<code>github.com/go-chassis/go-chassis</code>库中的<strong>middleware/ratelimiter</strong>和<strong>server/restful/api</strong>包找不到；</p></li> <li><p>第一反应是先看一下项目中依赖的go-chassis库是什么版本，执行<strong>go mod graph</strong>命令，这里将依赖关系绘制成如下图形：</p></li></ul> <p><img src="/assets/img/chassis_dependency.d2dfe746.png" alt=""></p> <ul><li>从图中可以看到，项目中依赖了两个版本的go-chassis库，一个是项目直接依赖，另一个是由其它库引用了；</li> <li>根据<strong>语义化版本</strong>的比较规则，这里最终选择的版本是<strong>v1.8.3</strong>；</li> <li>可以通过执行<strong>go list -m github.com/go-chassis/go-chassis</strong>命令来验证结果，如下命令输出所示，最终go-chassis版本为v1.8,3；</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>&gt;&gt; go list -m github.com/go-chassis/go-chassis**
github.com/go-chassis/go-chassis v1.8.3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><br> <ul><li>现在结果很明显了，<strong>middleware/ratelimiter</strong>和<strong>server/restful/api</strong>这两个包只存在<strong>v0.0.0-20200604060606-ba2932cb3029</strong>版本中，而在<strong>v1.8.3</strong>版本中是不存在的；以下是github的截图，可以验证这一点；</li></ul> <p><img src="/assets/img/middleware_ratelimiter.b45624e9.png" alt=""></p> <p><img src="/assets/img/restful_api.ea06b53a.png" alt=""></p> <br> <ul><li>但是这里还是有以下几个疑问暂时无法解释：</li></ul> <ol><li>为什么<strong>v1.8.3</strong>和<strong>v0.0.0-20200604060606-ba2932cb3029</strong>这两个版本之间会存在不兼容的问题，v1.8.3应该是向下兼容的？</li> <li>为什么项目中是怎么间接引用了go-chassis库的v1.8.3版本？</li> <li>为什么downlaod命令没有报错，tidy命令报错了？</li></ol> <br> <ul><li>接下来就是逐一寻找每个疑问的答案了；</li></ul> <br> <h4 id="疑问1-为什么会出现不兼容的问题？"><a href="#疑问1-为什么会出现不兼容的问题？" class="header-anchor">#</a> 疑问1 为什么会出现不兼容的问题？</h4> <ul><li>这个问题比较好解决，因为<strong>v0.0.0-20200604060606-ba2932cb3029</strong>是个伪版本号，这里直接根据commitid: <strong>ba2932cb3029</strong>来找到它的真实版本；</li></ul> <p><img src="/assets/img/ba2932c_version.19938d09.png" alt=""></p> <br> <ul><li>从上图可以看出，<strong>ba2932cb3029</strong>是v2.0.0-alpha.2之后提交的版本，主版本号和v1.8.3不一致，所以这里可以解释为什么会出现不兼容的问题；</li> <li>正是因为这里用的是伪版本号，所以go modules误以为<strong>v1.8.3</strong>版本是向下兼容的，所以最终选择较新的版本；</li></ul> <br> <h4 id="疑问2-v1-8-3版本是如何引入的？"><a href="#疑问2-v1-8-3版本是如何引入的？" class="header-anchor">#</a> 疑问2  v1.8.3版本是如何引入的？</h4> <ul><li>我们回头再看一下错误信息开头两行的描述：</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">go</span><span class="token punctuation">:</span> finding module <span class="token keyword">for</span> <span class="token keyword">package</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>security<span class="token operator">/</span>plugins<span class="token operator">/</span>aes
<span class="token keyword">go</span><span class="token punctuation">:</span> found github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>security<span class="token operator">/</span>plugins<span class="token operator">/</span>aes in github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis v1<span class="token punctuation">.</span><span class="token number">8.3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>第一行表示：tidy命令正在获取<strong>github.com/go-chassis/go-chassis/security/plugins/aes</strong>包文件；</li> <li>第二行表示： 在v1.8.3版本中找到了这个包；</li></ul> <br> <ul><li>到这里就会想，为啥不是在<strong>v0.0.0-20200604060606-ba2932cb3029</strong>版本中找呢，难道这个版本找不到吗？通过在github上查找对应源码，可以发现aes包不存在；而在v1.8.3版本中是存在的；</li></ul> <p><img src="/assets/img/miss_aes.7476c3cb.png" alt=""></p> <p><img src="/assets/img/1_8_3_exist_aes.62493b4e.png" alt=""></p> <br> <ul><li>那么到这里就可以解释v1.8.3是怎么引入进来的；</li> <li>但是又引入了新的疑问：<strong>github.com/go-chassis/go-chassis/security/plugins/aes</strong>包是怎么引入进来的；</li> <li>即使是执行<strong>go mod why github.com/go-chassis/go-chassis/security/plugins/aes</strong>命令也是出现类似的错误，无法从中得到有效的信息；</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token operator">&gt;&gt;</span> <span class="token keyword">go</span> mod why github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>security<span class="token operator">/</span>plugins<span class="token operator">/</span>aes
<span class="token keyword">go</span><span class="token punctuation">:</span> finding module <span class="token keyword">for</span> <span class="token keyword">package</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>middleware<span class="token operator">/</span>ratelimiter
<span class="token keyword">go</span><span class="token punctuation">:</span> finding module <span class="token keyword">for</span> <span class="token keyword">package</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>pkg<span class="token operator">/</span>profile
<span class="token keyword">go</span><span class="token punctuation">:</span> finding module <span class="token keyword">for</span> <span class="token keyword">package</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>server<span class="token operator">/</span>restful<span class="token operator">/</span>api
git<span class="token punctuation">.</span>garena<span class="token punctuation">.</span>com<span class="token operator">/</span>shopee<span class="token operator">/</span>bg<span class="token operator">-</span>logistics<span class="token operator">/</span>b2c<span class="token operator">/</span>sbs<span class="token operator">-</span>fbs<span class="token operator">-</span>server<span class="token operator">/</span>agent<span class="token operator">/</span>awb imports
        git<span class="token punctuation">.</span>garena<span class="token punctuation">.</span>com<span class="token operator">/</span>shopee<span class="token operator">/</span>bg<span class="token operator">-</span>logistics<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">/</span>chassis imports
        github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>middleware<span class="token operator">/</span>ratelimiter<span class="token punctuation">:</span> module github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis@latest found <span class="token punctuation">(</span>v1<span class="token punctuation">.</span><span class="token number">8.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> but does not contain <span class="token keyword">package</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>middleware<span class="token operator">/</span>ratelimiter
git<span class="token punctuation">.</span>garena<span class="token punctuation">.</span>com<span class="token operator">/</span>shopee<span class="token operator">/</span>bg<span class="token operator">-</span>logistics<span class="token operator">/</span>b2c<span class="token operator">/</span>sbs<span class="token operator">-</span>fbs<span class="token operator">-</span>server<span class="token operator">/</span>apps<span class="token operator">/</span>async_task<span class="token operator">/</span>schema imports
        git<span class="token punctuation">.</span>garena<span class="token punctuation">.</span>com<span class="token operator">/</span>shopee<span class="token operator">/</span>bg<span class="token operator">-</span>logistics<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">/</span>chassis<span class="token operator">/</span>protocol<span class="token operator">/</span>server<span class="token operator">/</span>restful imports
        github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>pkg<span class="token operator">/</span>profile<span class="token punctuation">:</span> module github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis@latest found <span class="token punctuation">(</span>v1<span class="token punctuation">.</span><span class="token number">8.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> but does not contain <span class="token keyword">package</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>pkg<span class="token operator">/</span>profile
git<span class="token punctuation">.</span>garena<span class="token punctuation">.</span>com<span class="token operator">/</span>shopee<span class="token operator">/</span>bg<span class="token operator">-</span>logistics<span class="token operator">/</span>b2c<span class="token operator">/</span>sbs<span class="token operator">-</span>fbs<span class="token operator">-</span>server<span class="token operator">/</span>apps<span class="token operator">/</span>async_task<span class="token operator">/</span>schema imports
        git<span class="token punctuation">.</span>garena<span class="token punctuation">.</span>com<span class="token operator">/</span>shopee<span class="token operator">/</span>bg<span class="token operator">-</span>logistics<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">/</span>chassis<span class="token operator">/</span>protocol<span class="token operator">/</span>server<span class="token operator">/</span>restful imports
        github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>server<span class="token operator">/</span>restful<span class="token operator">/</span>api<span class="token punctuation">:</span> module github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis@latest found <span class="token punctuation">(</span>v1<span class="token punctuation">.</span><span class="token number">8.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> but does not contain <span class="token keyword">package</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>server<span class="token operator">/</span>restful<span class="token operator">/</span>api
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><br> <ul><li>再仔细分析错误信息，可以看出，最终都是因为<strong>v1.8.3</strong>和<strong>v0.0.0-20200604060606-ba2932cb3029</strong>这两个版本不兼容导致命令无法执行下去，从而无法获取更多的信息，所以这里可以先用<strong>replace</strong>命令来规避这个兼容问题，强制使用<strong>v0.0.0-20200604060606-ba2932cb3029</strong>版本；</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code>replace github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis <span class="token operator">=</span><span class="token operator">&gt;</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis v0<span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">-</span><span class="token number">20200604060606</span><span class="token operator">-</span>ba2932cb3029
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><br> <ul><li>再次执行<strong>go mod tidy</strong>命令，这时出现了新的错误信息：</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token operator">&gt;&gt;</span> <span class="token keyword">go</span> mod tidy <span class="token operator">-</span>v                                                  
<span class="token keyword">go</span><span class="token punctuation">:</span> finding module <span class="token keyword">for</span> <span class="token keyword">package</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>security<span class="token operator">/</span>plugins<span class="token operator">/</span>aes
git<span class="token punctuation">.</span>garena<span class="token punctuation">.</span>com<span class="token operator">/</span>shopee<span class="token operator">/</span>bg<span class="token operator">-</span>logistics<span class="token operator">/</span>b2c<span class="token operator">/</span>sbs<span class="token operator">-</span>fbs<span class="token operator">-</span>server<span class="token operator">/</span>agent<span class="token operator">/</span>awb imports
        git<span class="token punctuation">.</span>garena<span class="token punctuation">.</span>com<span class="token operator">/</span>shopee<span class="token operator">/</span>bg<span class="token operator">-</span>logistics<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">/</span>chassis imports
        github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis imports
        github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>archaius<span class="token operator">/</span>source<span class="token operator">/</span>remote<span class="token operator">/</span>kie imports
        github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>archaius<span class="token operator">/</span>pkg<span class="token operator">/</span>kieclient imports
        github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>foundation<span class="token operator">/</span>httpclient tested by
        github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>foundation<span class="token operator">/</span>httpclient<span class="token punctuation">.</span>test imports
        github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>security<span class="token operator">/</span>plugins<span class="token operator">/</span>aes<span class="token punctuation">:</span> module github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis@latest found <span class="token punctuation">(</span>v1<span class="token punctuation">.</span><span class="token number">8.3</span><span class="token punctuation">,</span> replaced by github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis@v0<span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">-</span><span class="token number">20200604060606</span><span class="token operator">-</span>ba2932cb3029<span class="token punctuation">)</span><span class="token punctuation">,</span> but does not contain <span class="token keyword">package</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>security<span class="token operator">/</span>plugins<span class="token operator">/</span>aes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><br> <ul><li>到这里终于找到了罪魁祸首，从第9行可以看出，是<strong>github.com/go-chassis/foundation</strong>库将<strong>security/plugins/aes</strong>包引入进来的；</li> <li>然后这里的错误前面也提到过了，<strong>security/plugins/aes</strong>这个包在<strong>v0.0.0-20200604060606-ba2932cb3029</strong>版本是不存在的，而我们这里强制使用了<strong>v0.0.0-20200604060606-ba2932cb3029</strong>版本，所以肯定会报错；</li></ul> <br> <ul><li>到这里已经可以完全解答疑问2的问题了</li></ul> <br> <h4 id="疑问3-为什么download命令不报错？"><a href="#疑问3-为什么download命令不报错？" class="header-anchor">#</a> 疑问3 为什么download命令不报错？</h4> <ul><li>目前的线索就只剩下<strong>foundation</strong>库了，所以现在只能先看一下foundation库是怎么引入<strong>security/plugins/aes</strong>包的，看是否能从中获取新的信息；</li></ul> <br> <ul><li>首先找到<strong>foundation</strong>库当前所使用的版本，如下所示；</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token operator">&gt;&gt;</span> <span class="token keyword">go</span> list <span class="token operator">-</span>m github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>foundation                               
github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>foundation v0<span class="token punctuation">.</span><span class="token number">1.1</span><span class="token operator">-</span><span class="token number">0.20191113114104</span><span class="token operator">-</span><span class="token number">2</span>b05871e9ec4
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><br> <ul><li>接着在github上找到引用<strong>security/plugins/aes</strong>包的地方，如下所示：</li></ul> <p><img src="/assets/img/foundation_aes.19563405.png" alt=""></p> <br> <ul><li>可以看到是从一个单测文件上引入进来的；</li> <li>我的第一反应是单元测试文件在go build的时候是会忽略掉的；根据这个特性，这里大胆猜测了一下，download命令同样是会忽略掉单元测试文件，而tidy命令不会；如果这个推断成立，就可以解答疑问3的问题了；</li> <li>最终在官网上找到这样的描述可以证明猜测是对的，链接: <a href="https://golang.org/cmd/go/#hdr-Maintaining_module_requirements" target="_blank" rel="noopener noreferrer">https://golang.org/cmd/go/#hdr-Maintaining_module_requirements<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code>Any <span class="token keyword">go</span> command can determine that a module requirement is missing and must be added<span class="token punctuation">,</span> even 
when considering only a single <span class="token keyword">package</span> from the module<span class="token punctuation">.</span> 

On the other hand<span class="token punctuation">,</span> determining that a module requirement is no longer necessary and can be 
deleted requires a full view of all packages in the module<span class="token punctuation">,</span> across all possible build configurations <span class="token punctuation">(</span>architectures<span class="token punctuation">,</span> operating systems<span class="token punctuation">,</span> build tags<span class="token punctuation">,</span> and so on<span class="token punctuation">)</span><span class="token punctuation">.</span> 

The <span class="token string">'go mod tidy'</span> command builds that view and then adds any missing module requirements and removes unnecessary ones<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><br> <h4 id="解决"><a href="#解决" class="header-anchor">#</a> 解决</h4> <ul><li>解决完以上问题之后，我们就能得出最终的依赖关系图，如下所示：</li></ul> <p><img src="/assets/img/final_dependency.d4b2cd20.png" alt=""></p> <br> <ul><li>从图中可以看出，报错的根本原因是产生了钻石依赖；</li> <li>而出现钻石依赖的原因是由<strong>v0.0.0-20200604060606-ba2932cb3029</strong>版本造成的，因为它使用的是伪版本号，从而导致go modules在版本选择上误以为v1.8.3版本和它是向下兼容的，所以选择了v1.8.3版本；</li> <li>但实际上这两个版本是存在兼容性问题的，所以最终不管选择哪个版本都会出现某个包在另外一个版本找不到的错误；</li> <li>那么要解决这个问题就是要替换这个<strong>v0.0.0-20200604060606-ba2932cb3029</strong>版本，但是由于这个其实是一个v2版本，而要升级到v2版本是需要很多开发测试的工作来保证正确性和兼容性；所以目前是暂时无法升级；</li></ul> <br> <ul><li>那么只能从foundation库入手了，因为这个错误是从一个单元测试文件引入的，所以可以再找一个foundation库的版本，而该版本的单元测试是不会再引入go-chassis的依赖；最后再用<strong>replace命令</strong>强制使用该版本；</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code>replace github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>foundation <span class="token operator">=</span><span class="token operator">&gt;</span> github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>chassis<span class="token operator">/</span>foundation v0<span class="token punctuation">.</span><span class="token number">1.1</span><span class="token operator">-</span><span class="token number">0.20200825060850</span><span class="token operator">-</span>b16bf420f7b3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><br> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <ul><li>其实大部分go modules依赖的问题最终都可以用<strong>语义化版本控制</strong>和<strong>最小版本选择</strong>这两个规则来解释；所以只要了解这两个规则的含义，剩下的就是去找项目中到底是哪个包破坏了这两个规则；</li> <li>分析问题可以多使用<strong>go list</strong>和<strong>go mod graph</strong>命令，能够帮助梳理出所有包之间的依赖关系；</li></ul> <br> <h2 id="一些go-modules的使用建议"><a href="#一些go-modules的使用建议" class="header-anchor">#</a> 一些go modules的使用建议</h2> <ol><li>不建议使用伪版本号，除非这个库从来没有打tag，或者还没迁移到modules；</li> <li>需要遵循go modules包管理的兼容性规则，v0和v1版本需要保证向下兼容；大于v1的版本号，需要显式的在路径末尾添加主版本号；</li> <li>尽量不要使用预发版本，因为不能保证兼容性；</li> <li>尽量在提交代码前执行一次go mod tidy命令，保证go.mod文件的正确性和干净；</li></ol> <br> <br> <h2 id="参考文章"><a href="#参考文章" class="header-anchor">#</a> 参考文章</h2> <p><a href="https://mp.weixin.qq.com/s/nd8ic1Qk812ZqmHKSFITUQ" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/nd8ic1Qk812ZqmHKSFITUQ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://github.com/golang/go/wiki/Modules" target="_blank" rel="noopener noreferrer">https://github.com/golang/go/wiki/Modules<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://blog.golang.org/using-go-modules" target="_blank" rel="noopener noreferrer">https://blog.golang.org/using-go-modules<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://research.swtch.com/vgo-mvs" target="_blank" rel="noopener noreferrer">https://research.swtch.com/vgo-mvs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://research.swtch.com/vgo-import" target="_blank" rel="noopener noreferrer">https://research.swtch.com/vgo-import<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://golang.org/cmd/go/" target="_blank" rel="noopener noreferrer">https://golang.org/cmd/go/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit" style="display:none;"><!----> <!----></footer> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-44bd5a18 data-v-44bd5a18><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-44bd5a18><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-44bd5a18></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-44bd5a18></path></svg></div></div></div>
    <script src="/assets/js/app.89d7a7af.js" defer></script><script src="/assets/js/3.39c0dfdf.js" defer></script><script src="/assets/js/1.fc4f2573.js" defer></script><script src="/assets/js/10.8f886ff6.js" defer></script>
  </body>
</html>
