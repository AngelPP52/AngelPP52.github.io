(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{441:function(s,t,a){s.exports=a.p+"assets/img/SeaTalk_IMG_1606120299.c84d015f.jpg"},442:function(s,t,a){s.exports=a.p+"assets/img/cat_display_url.bb8b7bdb.png"},443:function(s,t,a){s.exports=a.p+"assets/img/connection_pool.e6024c81.png"},444:function(s,t,a){s.exports=a.p+"assets/img/release_connection.619c5a0e.png"},484:function(s,t,a){"use strict";a.r(t);var n=a(44),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"gorm误用导致的连接泄漏-死锁问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#gorm误用导致的连接泄漏-死锁问题"}},[s._v("#")]),s._v(" GORM误用导致的连接泄漏/死锁问题")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#gorm%E8%AF%AF%E7%94%A8%E5%AF%BC%E8%87%B4%E7%9A%84%E8%BF%9E%E6%8E%A5%E6%B3%84%E6%BC%8F%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98"}},[s._v("GORM误用导致的连接泄漏/死锁问题")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E6%95%85%E9%9A%9C%E7%8E%B0%E8%B1%A1"}},[s._v("故障现象")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90"}},[s._v("原因分析")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#1-infra%E9%97%AE%E9%A2%98"}},[s._v("1. infra问题?")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E9%AA%8C%E8%AF%81"}},[s._v("验证")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E7%BB%93%E8%AE%BA"}},[s._v("结论")])])])]),s._v(" "),n("li",[n("a",{attrs:{href:"#2-db%E9%97%AE%E9%A2%98"}},[s._v("2. DB问题?")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E7%BA%BF%E7%B4%A2"}},[s._v("线索")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E9%AA%8C%E8%AF%81-1"}},[s._v("验证")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E7%BB%93%E8%AE%BA-1"}},[s._v("结论")])])])])])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E6%9F%A5%E6%89%BE%E5%BA%94%E7%94%A8%E6%A0%B9%E5%9B%A0"}},[s._v("查找应用根因")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E4%BF%AE%E5%A4%8D%E9%AA%8C%E8%AF%81"}},[s._v("修复验证")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E6%80%BB%E7%BB%93"}},[s._v("总结")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#gorm%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"}},[s._v("gorm最佳实践")])])])])])]),s._v(" "),n("li",[n("a",{attrs:{href:"#databasesql%E8%BF%9E%E6%8E%A5%E6%B1%A0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"}},[s._v("database/sql连接池源码分析")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E8%8E%B7%E5%8F%96%E8%BF%9E%E6%8E%A5"}},[s._v("获取连接")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E9%87%8A%E6%94%BE%E8%BF%9E%E6%8E%A5"}},[s._v("释放连接")])])])])]),s._v(" "),n("h2",{attrs:{id:"故障现象"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#故障现象"}},[s._v("#")]),s._v(" 故障现象")]),s._v(" "),n("p",[s._v("11月23日下午，4点50分左右，PM同事发现oms-admin页面多个接口不响应，导致履约单数据无法加载，运营工作无法进行")]),s._v(" "),n("h2",{attrs:{id:"原因分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#原因分析"}},[s._v("#")]),s._v(" 原因分析")]),s._v(" "),n("h3",{attrs:{id:"_1-infra问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-infra问题"}},[s._v("#")]),s._v(" 1. infra问题?")]),s._v(" "),n("p",[s._v("cat没有相关url调用上报，怀疑请求没有到oms-admin来")]),s._v(" "),n("h4",{attrs:{id:"验证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#验证"}},[s._v("#")]),s._v(" 验证")]),s._v(" "),n("p",[s._v("找SRE查HAproxy的日志，发现http报了504错误，说明还是oms应用服务器超时导致的")]),s._v(" "),n("h4",{attrs:{id:"结论"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#结论"}},[s._v("#")]),s._v(" 结论")]),s._v(" "),n("p",[s._v("不是infra问题，是oms应用问题")]),s._v(" "),n("h3",{attrs:{id:"_2-db问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-db问题"}},[s._v("#")]),s._v(" 2. DB问题?")]),s._v(" "),n("h4",{attrs:{id:"线索"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#线索"}},[s._v("#")]),s._v(" 线索")]),s._v(" "),n("p",[s._v("再从cat上观察admin的接口的上报情况，发现不响应的接口都跟查询了db；有响应的接口都跟db无关。\n又因为api/gateway/flow等服务都在使用该db，但他们都没有问题，因此不太可能是db本身的问题, 应该重点关注应用层面的db操作相关的问题")]),s._v(" "),n("h4",{attrs:{id:"验证-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#验证-2"}},[s._v("#")]),s._v(" 验证")]),s._v(" "),n("p",[s._v("通过gdb和delve工具调试admin进程，发现程序有大量协程卡在database/sql包中获取连接的地方")]),s._v(" "),n("p",[n("img",{attrs:{src:a(441),alt:"goroutine_block"}})]),s._v(" "),n("p",[s._v("查看代码发现，database/sql获取连接的地方有一个逻辑是：当"),n("code",[s._v("已打开的连接数 >= 最大连接数")]),s._v("时，将会等待连接池中有可用的空闲连接。\ndatabase/sql/sql.go:1183")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Out of free connections or we were asked not to use one. If we're not")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// allowed to open any more connections, make a request and wait.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("maxOpen "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("numOpen "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">=")]),s._v(" db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("maxOpen "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Make the connRequest channel. It's buffered so that the")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// connectionOpener doesn't block while waiting for the req to be read.")]),s._v("\n    req "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("chan")]),s._v(" connRequest"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    reqKey "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("nextRequestKeyLocked")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("connRequests"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("reqKey"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" req\n    db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("waitCount"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v("\n    db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Unlock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    waitStart "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" time"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Timeout the connection request with the context.")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<-")]),s._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Done")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Remove the connection request and ensure no value has been sent")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// on it after removing.")]),s._v("\n        db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("delete")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("connRequests"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" reqKey"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Unlock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        atomic"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("AddInt64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("waitDuration"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("time"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Since")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("waitStart"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ok "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<-")]),s._v("req"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" ok "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conn "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("putConn")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Err")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ok "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<-")]),s._v("req"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        atomic"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("AddInt64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("waitDuration"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("time"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Since")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("waitStart"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("ok "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" errDBClosed\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("expired")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("lifetime"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Close")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" driver"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ErrBadConn\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conn "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("err\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Lock around reading lastErr to ensure the session resetter finished.")]),s._v("\n        ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lastErr\n        ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Unlock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" driver"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ErrBadConn "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Close")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" driver"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ErrBadConn\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("err\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br")])]),n("p",[s._v("本来有两条路径可以让select不再阻塞，一个是"),n("code",[s._v("case <-ctx.Done()")]),s._v("等待超时，一个是"),n("code",[s._v("case ret, ok := <-req:")]),s._v("有空闲连接可用。\n但不幸的是，由于database/sql的实现问题，ctx实际上被写死为一个Context.Background()，"),n("code",[s._v("case <-ctx.Done()")]),s._v("这一行永远也走不到。\n那就只有一条路径：等待空闲连接。如果等不到，那就会无限阻塞")]),s._v(" "),n("h4",{attrs:{id:"结论-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#结论-2"}},[s._v("#")]),s._v(" 结论")]),s._v(" "),n("p",[s._v("因此现在问题明确了，就是***连接泄漏导致的连接池资源耗尽，导致新请求获取连接时无限等待，造成请求不响应***。这也解释了为什么出现了第一个猜测的现象"),n("code",[s._v("cat没有相关url调用上报")]),s._v("，因为oms的cat上报实现是在请求返回后才上报的，如果请求不返回，那么就不会上报")]),s._v(" "),n("h2",{attrs:{id:"查找应用根因"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#查找应用根因"}},[s._v("#")]),s._v(" 查找应用根因")]),s._v(" "),n("p",[s._v("该现象在11月23日，11月25日4点过都发生过，且只在VN发生，因此考虑是否因为vn收到了某个不经常触发的请求，导致了该问题。")]),s._v(" "),n("p",[s._v("根据cat上报的信息，果然我们查到11月23日，11月25日4点50分左右，sls大量调用了admin_api/asf/update接口，之后就没有其他请求的cat上报了，admin页面也确实不响应了。")]),s._v(" "),n("p",[s._v("接下来就开始分析该接口内部的逻辑，经过同事们的共同努力，最终确定了一个最可疑的地方，其代码如下(省略无关代码):")]),s._v(" "),n("div",{staticClass:"language-golang line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("func UpdateAsf(asf_log) {\n    for i := 0; i < 5; i++ {\n        go func {\n            txn := gorm.Begin()\n            defer func {\n                if err != nil {\n                    txn.RollBack()\n                }else {\n                    txn.Commit()\n                }\n            }\n            //不在事务中的query\n            gorm.Query()\n            \n            txn.Update()\n        }\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("这段代码的问题在于，该流程在一个协程中，想同时获取了两个连接。当gorm.Begin()时，会获取一个连接由txn对象持有，在txn.Rollback()或txn.Commit()之前，该连接都不会被释放。而下面一个语句"),n("code",[s._v("gorm.Query()")]),s._v("又尝试去获取连接。")]),s._v(" "),n("p",[s._v("可能出现txn获取了连接，而"),n("code",[s._v("gorm.Query()")]),s._v("短时间无法获取连接的情况。由于database/sql的实现问题，"),n("code",[s._v("gorm.Query()")]),s._v("如果一直卡住，又造成了txn的连接无法释放，进一步加重了连接池的消耗。在高并发的情况下，每多一个协程发生这样的情况，就多消耗一些连接，雪球越滚越大，最终造成了死锁。")]),s._v(" "),n("p",[s._v("oms-admin服务设置的"),n("code",[s._v("MaxConnectionsNum = 200")]),s._v("，代码本身有5倍并发的操作，如果接口的并发达到40，就容易出现该现象了！")]),s._v(" "),n("p",[s._v("我们实际查看当时的请求量\n"),n("img",{attrs:{src:a(442),alt:"cat_display_url"}}),s._v("\n虽然不能直接看得出来qps或者并发度，但是看得出，平时几乎没有请求记录的该接口，突然有了540个请求。瞬时并发超过40这个说法，也是可以说得通的")]),s._v(" "),n("h2",{attrs:{id:"修复验证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#修复验证"}},[s._v("#")]),s._v(" 修复验证")]),s._v(" "),n("p",[s._v("代码修改为不使用txn方式更新，使用一般的gorm.Update()方法，在staging环境高并发调用admin_api/asf/update接口进行验证。当时，仍然会出现几秒到几十秒的延迟，因为请求在排队，当不再发送请求之后，排队的请求也拿到了连接后，最终可以返回。我们认为该问题得到解决")]),s._v(" "),n("h2",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),n("h3",{attrs:{id:"gorm最佳实践"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#gorm最佳实践"}},[s._v("#")]),s._v(" gorm最佳实践")]),s._v(" "),n("p",[s._v("在使用gorm类库的时候，有两种用法也会导致连接泄漏，供大家参考：")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("txn.Begin()之后，忘记txn.RollBack()或txn.Commit()。推荐将提交或回滚的方法放在defer里，以免因为panic而不释放连接")]),s._v(" "),n("div",{staticClass:"language-golang line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("func BusinessAction() error {\n    var err error\n    txn := gorm.Begin()\n    defer func {\n        if err != nil {\n            txn.RollBack()\n        }else {\n            txn.Commit()\n        }\n    }\n    err = txn.Update(table1)\n    if err != nil {\n        return err\n    }\n    \n    err = txn.Update(table2)\n    if err != nil {\n        return err\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("某些场景要裸写sql进行query查询，使用到了gorm().DB().Query()方法。该方法会返回一个Rows对象，如果没有对该对象调用Close()方法，也会导致连接泄漏")]),s._v(" "),n("div",{staticClass:"language-golang line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("func BusinessAction() error {\n    rows, err := gorm.DB().Query(your_sql)\n    if err != nil {\n        return err\n    }\n    defer rows.Close()\n    \n    for _, row := range {\n        yourBusiness(row)\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])])])]),s._v(" "),n("h1",{attrs:{id:"database-sql连接池源码分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#database-sql连接池源码分析"}},[s._v("#")]),s._v(" database/sql连接池源码分析")]),s._v(" "),n("p",[s._v("连接池管理是由golang自带的database/sql库完成的，而非gorm。")]),s._v(" "),n("h2",{attrs:{id:"获取连接"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#获取连接"}},[s._v("#")]),s._v(" 获取连接")]),s._v(" "),n("p",[s._v("大概流程如图所示\n"),n("img",{attrs:{src:a(443),alt:"get_conn"}})]),s._v(" "),n("ol",[n("li",[s._v("用户请求协程会优先从"),n("strong",[s._v("空闲连接池")]),s._v("获取连接。如果能获取到，判断连接是否过期；过期则丢弃报错，否则正常返回给用户")]),s._v(" "),n("li",[s._v("如果"),n("strong",[s._v("空闲连接池")]),s._v("没有资源，尝试去创建连接。再根据启动参数"),n("code",[s._v("MaxOpenConnections")]),s._v("来判断是否已经达到最大连接数，如果没达到，直接建立新连接；\n如果达到，则当前协程会阻塞等待，将该请求放入等待池，直到"),n("code",[s._v("connectionOpener协程")]),s._v("返回新的连接，否则将一直挂起。此处也是本文描述的发生死锁的地方。")]),s._v(" "),n("li",[s._v("用户请求协程和"),n("code",[s._v("connectionOpener协程")]),s._v("都各自会有机会将"),n("strong",[s._v("请求等待池")]),s._v("的请求加载到"),n("strong",[s._v("新建请求队列")]),s._v("(它本质上是一个channel)，触发"),n("code",[s._v("connectionOpener协程")]),s._v("去建立新的连接")]),s._v(" "),n("li",[s._v("连接被创建后会优先供给给正在等待的请求协程，如果没有正在等待的请求，则放入"),n("strong",[s._v("空闲连接池")]),s._v("，以供后面的请求使用")])]),s._v(" "),n("p",[s._v("可以看出其设计的几个特点：")]),s._v(" "),n("ol",[n("li",[s._v("用户线程不创建新连接，全都交给"),n("code",[s._v("connectionOpener协程")]),s._v("去创建，好处是可以避免高并发创建大量连接")]),s._v(" "),n("li",[s._v("请求等待池的实现是一个map，"),n("code",[s._v("connectionOpener协程")]),s._v("激活等待中的用户请求协程时，并没有将连接优先给等待时间更长的协程，\n而是随机分配的。是一个非公平的分配机制")])]),s._v(" "),n("h2",{attrs:{id:"释放连接"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#释放连接"}},[s._v("#")]),s._v(" 释放连接")]),s._v(" "),n("p",[s._v("大概流程如图所示\n"),n("img",{attrs:{src:a(444),alt:"get_conn"}})]),s._v(" "),n("ol",[n("li",[s._v("如果该连接在使用时发生错误将会被丢弃，同时触发创建新连接")]),s._v(" "),n("li",[s._v("被释放的连接优先满足正在等待的请求协程，其次放回空闲连接池")]),s._v(" "),n("li",[s._v("被正常归还的连接将在"),n("code",[s._v("connectionResetter协程")]),s._v("中进行健康检查")])])])}),[],!1,null,null,null);t.default=e.exports}}]);